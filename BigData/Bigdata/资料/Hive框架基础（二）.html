<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hive框架基础（二）</title>
    <style type="text/css" media="all">
      body {
        margin: 0;
        font-family: "Helvetica Neue", Helvetica, Arial, "Hiragino Sans GB", sans-serif;
        font-size: 14px;
        line-height: 20px;
        color: #777;
        background-color: white;
      }
      .container {
        width: 700px;
        margin-right: auto;
        margin-left: auto;
      }

      .post {
        font-family: Georgia, "Times New Roman", Times, "SimSun", serif;
        position: relative;
        padding: 70px;
        bottom: 0;
        overflow-y: auto;
        font-size: 16px;
        font-weight: normal;
        line-height: 25px;
        color: #515151;
      }

      .post h1{
        font-size: 50px;
        font-weight: 500;
        line-height: 60px;
        margin-bottom: 40px;
        color: inherit;
      }

      .post p {
        margin: 0 0 35px 0;
      }

      .post img {
        border: 1px solid #D9D9D9;
      }

      .post a {
        color: #28A1C5;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="post">
        <h1 class="title">Hive框架基础（二）</h1>
        <div class="show-content">
          <h1>* Hive框架基础（二）<br>
</h1><p>我们继续讨论hive框架</p><h2>* Hive的外部表与内部表</h2><p><b>内部表：hive默认创建的是内部表</b></p><p>例如：</p><p>create table table001 (name string , age string) location '/input/table_data';<br></p><p>此时：会在HDFS上新建一个table001表的数据存放地</p><p>接着执行：</p><p>load data inpath'/input/data 'into table table001;（注意，load关键字后没有跟local关键字）<br></p><p>** 会将hdfs上的/input/data目录下的数据转移到/input/table_data目录下</p><p>** 如果删除table001表，会将table001表的数据和元数据信息全部删除，即最后/input/table_data下无数据</p><p>** 由于此处load是将HDFS中的数据移到HDFS另一个 目录，所以，/input/data中的数据已经删除。</p><p>** 如果创建内部表时没有指定location，就会在/user/<a href="http://lib.csdn.net/base/hive" target="_blank">Hive</a>/warehouse/下新建一个表目录</p><p><b>外部表：默认创建的不是外部表，需要使用external关键字标识</b></p><p>例如：</p><p>create external table etable001(name string, age string);<br></p><p>会在/user/hive/warehouse/新建一个表目录et<br></p><p>接着执行：</p><p>load data inpath '/input/edata' into table etable001;（注意，load关键字后没有跟local关键字）<br></p><p>** 把hdfs上/input/edata/下的数据转到/user/hive/warehouse/et下</p><p>** 删除这个外部表后，/user/hive/warehouse/et下的数据不会删除</p><p>** 由于此处load是将HDFS中的数据移到HDFS另一个 目录，所以，/input/data中的数据已经删除。（和内部表的操作情况一致）</p><p><b>总结：</b></p><p>** 外部表中的数据并不是由它自己来管理，而内部表则不一样；<br></p><p>** 在删除内部表的时候，Hive将会把属于表的元数据和数据全部删掉；而删除外部表的时候，Hive仅仅删除外部表的元数据，数据是不会删除的。</p><p>**  在创建内部表或外部表时加上location的效果是一样的，只不过表目录的位置不同而已，加上partition用法也一样，只不过表目录下会有分区目录而已（后续会讲到）</p><p>** load data local inpath直接把本地文件系统的数据上传到HDFS上，如果指定了location，则上传到指定位置，没有的话上传到hive默认配置的数据仓库中。</p><p>** 外部表相对来说更加安全，数据组织也更加灵活，方便共享源数据。</p><h2>* Hive分区表</h2><p>** 创建表的时候只需要指定分区字段，分区范围是在加载数据的时候才指定的<br></p><p>** 对大表数据进行分类存储，提高数据安全性</p><p>** 使用分区表能大大的提高查询效率</p><p><b>** 创建分区表</b></p><p><b>此部分直接举例说明，讲解这部分知识涉及到的例子所需要用到的数据材料请到传送门下载：</b></p><p>链接：http://pan.baidu.com/s/1dFCFuSD 密码：fc41</p><p>create database if not exists db_web_data ;<br></p><p>create table if not exists db_web_data.track_log(</p><p>id              string,</p><p>url             string,</p><p>referer         string,</p><p>keyword         string,</p><p>type            string,</p><p>guid            string,</p><p>pageId          string,</p><p>moduleId        string,</p><p>linkId          string,</p><p>attachedInfo    string,</p><p>sessionId       string,</p><p>trackerU        string,</p><p>trackerType     string,</p><p>ip              string,</p><p>trackerSrc      string,</p><p>cookie          string,</p><p>orderCode       string,</p><p>trackTime       string,</p><p>endUserId       string,</p><p>firstLink       string,</p><p>sessionViewNo   string,</p><p>productId       string,</p><p>curMerchantId   string,</p><p>provinceId      string,</p><p>cityId          string,</p><p>fee             string,</p><p>edmActivity     string,</p><p>edmEmail        string,</p><p>edmJobId        string,</p><p>ieVersion       string,</p><p>platform        string,</p><p>internalKeyword string,</p><p>resultSum       string,</p><p>currentPage     string,</p><p>linkPosition    string,</p><p>buttonPosition  string</p><p>)</p><p>partitioned by (date string,hour string)</p><p>row format delimited fields terminated by '\t';</p><p>字段设计缘由请参看字典：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-276dba373f97c9ce.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-276dba373f97c9ce.png?imageMogr2/auto-orient/strip" data-image-slug="276dba373f97c9ce" data-width="1896" data-height="2063"><br><div class="image-caption"></div>
</div><p>将以上文本包含的sql命令保存到p2.hql文件中，然后使用命令：</p><p>$ bin/hive -f hqlDir/p2.hql，如图：<br></p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-7fdad2d944dd80fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-7fdad2d944dd80fa.png?imageMogr2/auto-orient/strip" data-image-slug="7fdad2d944dd80fa" data-width="1420" data-height="190"><br><div class="image-caption">这里我把hql文件归类到了自己创建的hqlDir文件夹中</div>
</div><p><b>** 加载数据</b></p><p>首先将“2015082818”和“2015082819”两个文件考入到/home/z/Desktop目录下</p><p>使用命令：</p><p>hive (default)&gt; load data local inpath '/home/z/Desktop/2015082818' into table db_web_data.track_log partition(date='20150828',hour='18');<br></p><p>hive (default)&gt; load data local inpath '/home/z/Desktop/2015082819' into table db_web_data.track_log partition(date='20150828',hour='19');</p><p><b>** 查询数据</b></p><p>hive (default)&gt; select * from db_web_data.track_log where date='20150828' ; <br></p><p>hive (default)&gt; select * from db_web_data.track_log where date='20150828' and hour='18';</p><p>（这里由于数据量太大，就不给大家截图展示了）</p><p><b>拓展：</b></p><p>查看一个分区表有几个分区<br></p><p>hive (db_web_data)&gt; show partitions track_log ;</p><p>删除一个分区表的分区</p><p>hive (db_web_data)&gt; alter table track_log drop partition(date='xxxx',hour='xxxx') ;</p><h2>* Hive创建表的方式</h2><p><b>** 方案一</b></p><p>即创建一个空表，例如之前我们一直用到的方式。</p><p><b><b>** 方案二</b><br></b></p><p>即把一张表的某些字段抽取出来，创建成一张新表</p><p>例如：</p><p>create table db_web_data.backup_track_log as select * from db_web_data.track_log;</p><p><b><b><b>** 方案三</b><br></b></b></p><p>复制表结构</p><p>尖叫提示：以上创建表的过程均可以使用location指定创建位置，也可以不指定。</p><p>例如：</p><p>create table db_web_data.like_track_log like db_web_data.track_log;</p><h2><b><b><b>* Hive表导入数据方式</b></b></b></h2><p><b><b><b>** 方案一</b></b></b></p><p>加载本地文件到Hive表</p><p>load data local inpath 'path/file' into table 表名称 ;<br></p><p><b><b><b><b><b><b>** 方案二</b></b></b><br></b></b></b></p><p>加载HDFS文件到HIVE表（即方案2没有local关键字）</p><p>load data inpath 'path/file' into table 表名称 ;<br></p><p><b><b><b><b><b><b><b><b><b>** 方案三</b></b></b><br></b></b></b></b></b></b></p><p>加载数据覆盖表中已有的数据<br></p><p>load data local inpath 'path/file' overwrite into table 表名称 ;<br></p><p><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b>** 方案四</b></b></b></b></b></b></b></b></b><br></b></b></b></b></b></b></b></b></b></p><p>创建表时通过select加载<br></p><p>create table db_web_data.track_log_as as select * from db_web_data.track_log;<br></p><p><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b>** 方案五</b></b></b></b></b></b></b></b></b><br></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></p><p>用insert命令加载<br></p><p>*** 应用场景：把用select命令分析的结果写入某个临时表<br></p><p>*** append 追加写入   --默认</p><p>*** overwrite 覆盖写入	--使用最多</p><p>--先要创建好表，然后再写入数据</p><p>insert into table 表名 select * from db_web_data.track_log;</p><p>insert overwrite table 表名 select * from db_web_data.track_log;</p><h2>
<b><b><b>* Hive表导出数据方式</b></b></b><br>
</h2><p><b><b><b><b><b><b>** 方案一</b></b></b><br></b></b></b></p><p>insert...local diretory导出到本地<br></p><p>例如：</p><p>insert overwrite local directory "/home/z/Desktop/backup" row format delimited fields terminated by '\t' select * from staff ;<br></p><p><b><b><b><b><b><b><b><b><b><b><b><b>** 方案二</b></b></b></b></b></b><br></b></b></b></b></b></b></p><p>insert..diretory导出到HDFS<br></p><p>例如：</p><p>insert overwrite diretory "path/" select * from staff;<br></p><p><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b>** 方案三</b></b></b></b></b></b><br></b></b></b></b></b></b></b></b></b></b></b></b></p><p>直接在linux段，使用hive -e命令执行hql语句</p><p>例如：</p><p>$ bin/hive -e "select * from staff;"  &gt; /home/z/backup.log<br></p><p><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b>** 方案四</b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></p><p>sqoop工具（后面讨论）</p><h2><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b><b>* Hive语句基本拓展</b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></b></h2><p>** 查询具体的某个某些字段<br></p><p>例如：</p><p>select name, sex from staff;</p><p>** where</p><p>select * from staff where name='隔壁老王';</p><p>注：where 条件可以是分区字段</p><p>** limit</p><p>select * from track_log limit 1 ;</p><p>** distinct 去重</p><p>select distinct(name)  from staff ;</p><p>** &lt; &gt; = &gt;= &lt;=  !=</p><p>select * from staff where id &gt; 5000 ;</p><p>** and  、between ... and ... 、 not in 、in</p><p>** like  %   _</p><p>**  +  -  *  /</p><p>以上各种运用详细可以参考sql语法</p><h2>* Hive 常用函数</h2><p><b>** 查看有哪些函数</b><br></p><p>hive (default)&gt; show functions;<br></p><p><b>** 查看具体某个函数的用法</b><br></p><p>hive (default)&gt; desc function extended max ;</p><p>** 常用函数一些用法</p><hr><p>假设情景：我们有如下两个表，分别是员工信息表emp和部门信息表dept，表内容如下图：</p><p>emp：<br></p><p>字段：empno int, ename string, job string, mgr int, hiredate string, sal double, comm double, deptno int</p><p>字段对应数据：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-15a4744337329168.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-15a4744337329168.png?imageMogr2/auto-orient/strip" data-image-slug="15a4744337329168" data-width="634" data-height="293"><br><div class="image-caption"></div>
</div><p>dept：</p><p>字段：deptno int, dname string, loc string</p><p>字段对应数据：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-e059a1908337d31a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-e059a1908337d31a.png?imageMogr2/auto-orient/strip" data-image-slug="e059a1908337d31a" data-width="257" data-height="91"><br><div class="image-caption"></div>
</div><p>请自行创建数据库：</p><p>db_emp_dept</p><p>以及对应表：</p><p>emp、dept</p><p>并导入数据</p><p>链接：http://pan.baidu.com/s/1qY8pjTq 密码：54w6<br></p><p>最终如图：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-cc8ebb722f800d55.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-cc8ebb722f800d55.png?imageMogr2/auto-orient/strip" data-image-slug="cc8ebb722f800d55" data-width="1006" data-height="862"><br><div class="image-caption"></div>
</div><hr><p>以上面的情景，解释下面的函数：</p><p><b>*** </b><b>最大值统计函数: max</b></p><p>语法: max(col)</p><p>返回值: double</p><p>说明:统计结果集中col字段的最大值</p><p>例如：显示每个部门最高薪资<br></p><p>select deptno,max(sal) from emp group by deptno ;</p><p>结果如图：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-19d9e0393bc634ea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-19d9e0393bc634ea.png?imageMogr2/auto-orient/strip" data-image-slug="19d9e0393bc634ea" data-width="475" data-height="132"><br><div class="image-caption"></div>
</div><p>例如：显示部门名称, 部门最高薪资</p><p>select max(b.dname),max(sal) from emp a inner join dept b on a.deptno = b.deptno group by a.deptno ;<br></p><p>结果如图：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-a38adbeca001dc2a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-a38adbeca001dc2a.png?imageMogr2/auto-orient/strip" data-image-slug="a38adbeca001dc2a" data-width="531" data-height="133"><br><div class="image-caption"></div>
</div><p>或者：select b.dname,max(sal) from emp a inner join dept b on a.deptno = b.deptno group by a.deptno,dname ;<br></p><p>结果如图：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-37197755f54c8f72.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-37197755f54c8f72.png?imageMogr2/auto-orient/strip" data-image-slug="37197755f54c8f72" data-width="482" data-height="127"><br><div class="image-caption"></div>
</div><p><b>*** 最小值统计函数: min</b></p><p>语法：min(col)</p><p>返回值:：double</p><p>说明：统计结果集中col字段的最小值</p><p>例如：显示部门名称, 部门最高薪资, 部门所在的城市</p><p>select max(dname),max(sal),min(loc) from emp inner join dept on emp.deptno = dept.deptno group by emp.deptno ;<br></p><p>结果如图：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-e973d797df2b67c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-e973d797df2b67c5.png?imageMogr2/auto-orient/strip" data-image-slug="e973d797df2b67c5" data-width="531" data-height="129"><br><div class="image-caption"></div>
</div><p><b>*** 平均值统计函数: avg</b><br></p><p>语法: avg(col), avg(DISTINCT col)</p><p>返回值: double</p><p>说明: avg(col)统计结果集中col的平均值；avg(DISTINCT col)统计结果中col不同值相加的平均值</p><p>例如：请参照前文内容，自行测试</p><p><b>*** 总和统计函数: sum</b></p><p>语法: sum(col), sum(DISTINCT col)</p><p>返回值: double</p><p>说明: sum(col)统计结果集中col的相加的结果；sum(DISTINCT col)统计结果中col不同值相加的结果</p><p>例如：请参照前文内容，自行测试<br></p><p><b>*** 个数统计函数: count</b></p><p>语法: count(*), count(expr), count(DISTINCT expr[, expr_.])</p><p>返回值: int</p><p>说明: count(*)统计检索出的行的个数，包括NULL值的行；count(expr)返回指定字段的非空值的个数；count(DISTINCTexpr[, expr_.])返回指定字段的不同的非空值的个数</p><p>例如：请参照前文内容，自行测试</p><p><b>*** 取随机数函数: rand</b></p><p>语法： rand(),rand(int seed)</p><p>返回值： double</p><p>说明：返回一个0到1范围内的随机数。如果指定种子seed，则会等到一个稳定的随机数序列</p><p>例如：select rand();</p><p><b>*** 字符串连接函数：concat</b></p><p>语法: concat(string A, string B…)</p><p>返回值: string</p><p>说明：返回输入字符串连接后的结果，支持任意个输入字符串</p><p>例如：select concat(empno,"_",ename) from emp ;</p><p>结果如图：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-e39c84ebd02f83f8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-e39c84ebd02f83f8.png?imageMogr2/auto-orient/strip" data-image-slug="e39c84ebd02f83f8" data-width="461" data-height="364"><br><div class="image-caption"></div>
</div><p><b>*** 字符串截取函数：substr</b><br></p><p>语法: substr(string A, int start, int end)</p><p>返回值: string</p><p>说明：返回字符串A从start位置到结尾end的字符串，end不填写，则默认为末尾。</p><p>例如：select substr(hiredate,1,4) from emp ;(请自行去掉4，再试一次，即可明白)</p><p>结果如图：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-0e4fc3d06d337f5c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-0e4fc3d06d337f5c.png?imageMogr2/auto-orient/strip" data-image-slug="0e4fc3d06d337f5c" data-width="474" data-height="365"><br><div class="image-caption"></div>
</div><p><b>*** 字符串转大写函数：upper</b></p><p>语法: upper(string A)</p><p>返回值: string</p><p>说明：返回字符串A的大写格式</p><p><b>*** 字符串转小写函数：lower</b><br></p><p>语法: lower(string A)</p><p>返回值: string</p><p>说明：返回字符串A的小写格式</p><p><b>*** 日期转天函数: day</b></p><p>语法: day (string date)</p><p>返回值: int</p><p>说明:返回日期中的天。</p><p>例如：select day(hiredate) from emp ;</p><p>结果如图：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-3eda9c4e352dde79.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-3eda9c4e352dde79.png?imageMogr2/auto-orient/strip" data-image-slug="3eda9c4e352dde79" data-width="470" data-height="361"><br><div class="image-caption"></div>
</div><p><b>*** 日期转小时函数: hour</b><br></p><p>语法: hour (string date)</p><p>返回值: int</p><p>说明:返回日期中的小时。</p><p>例如：select hour("2016-09-01 12:34:34") ;</p><p><b>*** 日期转分钟函数: minute</b><br></p><p>语法: minute (string date)</p><p>返回值: int</p><p>说明:返回日期中的分钟。</p><p><b>*** 日期转秒函数: second</b></p><p>语法: second (string date)</p><p>返回值: int</p><p>说明:返回日期中的秒。</p><p><b>*** 日期转UNIX时间戳函数:unix_timestamp</b></p><p>语法: unix_timestamp(string date)</p><p>返回值: bigint</p><p>说明:转换格式为"yyyy-MM-ddHH:mm:ss"的日期到UNIX时间戳。如果转化失败，则返回0。</p><p>举例：</p><p>select unix_timestamp("2018-07-07 12:34:34") ;<br></p><p>select unix_timestamp('2011-12-07 13:01:03') from table;</p><p><b>*** UNIX时间戳转日期函数:from_unixtime</b><br></p><p>语法: from_unixtime(bigint unixtime[, string format])</p><p>返回值: string</p><p>说明:转化UNIX时间戳（从1970-01-01 00:00:00 UTC到指定时间的秒数）到当前时区的时间格式</p><p>例如：</p><p>select from_unixtime(1472704474) ;</p><p>select from_unixtime(1472704474,'yyyyMMdd') from table;</p><p><b>*** 类型转换函数：cast</b></p><p>类型转换函数: cast</p><p>语法: cast(expr as )</p><p>返回值: Expected "=" to follow "type"</p><p>说明:返回array类型的长度</p><p>例如：select cast(1472704474123/1000 as int) ;</p><p><b>*** 条件判断函数：CASE</b></p><p>语法: CASE WHEN a THEN b [WHEN c THEN d]* [ELSE e] END</p><p>返回值: T</p><p>说明：如果a为TRUE,则返回b；如果c为TRUE，则返回d；否则返回e</p><p>例如：</p><p>&gt; select ename,sal+comm from emp ;<br></p><p>hive (db_emp_dept)&gt; select ename,</p><p>&gt; case when comm is null then 0+sal</p><p>&gt; else comm+sal end</p><p>&gt; from emp ;</p><p>hive (db_emp_dept)&gt; select ename,</p><p>&gt; case when sal&lt;1000 then "lower"</p><p>&gt; when sal&gt;=1000 and sal&lt;=2000 then "pass"</p><p>&gt; when sal&gt;2000 then "high"</p><p>&gt; else "OK" end</p><p>&gt; from emp ;</p><p>hive (db_emp_dept)&gt; select ename,</p><p>&gt; case when sal&lt;1000 then deptno</p><p>&gt; when sal&gt;=1000 and sal&lt;=2000 then comm</p><p>&gt; else null end</p><p>&gt; from emp ;</p><p>对于语法不了解的，请移步：<a href="http://www.w3school.com.cn/sql/sql_join_inner.asp" target="_blank">SQL基础</a></p><h2>* Hive explain 解析执行计划</h2><p>hive是把sql语句翻译成mapreduce任务来执行的，那么具体mapreduce是怎么一个执行结构，可以在sql前面加上explain关键字来查看。</p><p>例如：</p><p>explain select count(distinct(deptno))  from emp ;<br></p><h2>* Hive 设定哪些语句执行mapreduce运算</h2><p>参数名：hive.fetch.task.conversion</p><p>参数值：minimal或者more</p><p>从Hive 0.10.0版本开始，对于简单的不需要聚合的语句，比如select &lt;clo&gt; from &lt;table&gt; limit n这样的语句，根本不需要启动mapreduce job，直接通过fetch task即可获取数据，那么此时，我们就配置这个属性的值为more即可。可以查看对应的官方解释如下：</p><p>配置后如图：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-93ac7b39b120a5c0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-93ac7b39b120a5c0.png?imageMogr2/auto-orient/strip" data-image-slug="93ac7b39b120a5c0" data-width="837" data-height="229"><br><div class="image-caption"></div>
</div><h2>* 配置HiveServer2服务</h2><p>启动Hive有如下几种方式：</p><p>1、 hive  命令行模式<br></p><p>进入hive安装目录，输入bin/hive的执行程序，或者输入 hive –service cli</p><p>用于linux平台命令行查询，查询语句基本跟sql查询语句类似</p><p>2、hive  web界面的启动方式，没什么用<br></p><p>3、hive  远程服务 (端口号10000) 启动方式</p><p>bin/hive –service hiveserver2</p><p>用java，python等程序实现通过jdbc等驱动的访问hive。</p><p><b>** 配置hive-site.xml</b></p><p>属性：hive.server2.thrift.port，值：10000</p><p>属性：hive.server2.thrift.bind.host，值：z01</p><p>属性：hive.server2.long.polling.timeout，值：5000(注意，此处去掉默认带有的L)</p><p>此处就不再配图了。</p><p><b>** 检查端口</b></p><p>首先，检查10000端口是否被占用：</p><p>$ netstat -antp|grep 10000<br></p><p>如果被占用，使用kill -9 &lt;pid&gt;杀掉</p><p><b>** 启动服务</b></p><p>$ bin/hive --service hiveserver2<br></p><p><b>注意：service前面有两个“-”</b></p><p><b>** 连接服务</b></p><p>$ bin/beeline</p><p>beeline&gt; help</p><p>&gt; !connect jdbc:hive2://z01:10000</p><p><b>（注意：此处如果直接敲回车，不使用用户登录，那么默认为匿名登录，用户名为：anonymous，无密码）</b></p><p><b><b>（注意：在我这里，我也可以使用z这个用户名登录，密码是我自己的密码）</b><br></b></p><p>&gt; select * from db_emp_dept.emp ;</p><p>如图：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-3a56cb4bebdef390.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-3a56cb4bebdef390.png?imageMogr2/auto-orient/strip" data-image-slug="3a56cb4bebdef390" data-width="1089" data-height="666"><br><div class="image-caption"></div>
</div><p><b>注意，如果需要执行Job任务，则：</b><br></p><p>首先修改该属性</p><p>hive.server2.enable.doAs：false<br>解释：改属性为true时，启动hiveServer2的用户为当前默认用户，访问Hadoop则也用该用户。</p><p>如果为false，则beeline中登录的是哪个用户，就用哪个用户，这里我的环境中，可以使用<b>“z”</b>这个用户。</p><p>这样一来，才能成功在hiveServer2中提交并运行Job任务。</p><h2>* UDF<br>
</h2><p>即：user defined function</p><p>UDF函数开发要点:<br></p><p>** 必须继承UDF类</p><p>** 重写evaluate函数</p><p>** 必须要有返回类型,可以返回null,但是返回类型不能为void</p><p>** 建议使用Text/LongWritable</p><p><b>** 环境配置</b></p><p>1、在eclipse中创建一个maven项目，并修改pom依赖包，添加如图所示内容：</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-717316c6f627126e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-717316c6f627126e.png?imageMogr2/auto-orient/strip" data-image-slug="717316c6f627126e" data-width="343" data-height="224"><br><div class="image-caption"></div>
</div><p>2、上传repository.tar.gz,并解压到/home/z/.m2/</p><p>3、修改maven的配置文件</p><p>$ vi /opt/modules/apache-maven-3.0.5/conf/settings.xml</p><p>在mirrors标签中加入如下内容：<br></p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-1f883954fd0b2e41.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-1f883954fd0b2e41.png?imageMogr2/auto-orient/strip" data-image-slug="1f883954fd0b2e41" data-width="677" data-height="282"><br><div class="image-caption"></div>
</div><p>接着，将该文件拷贝到.m2目录下：</p><p>$ cp settings.xml /home/z/.m2/<br></p><p>4、更新maven工程</p><p>在eclipse中右键项目，选择maven-update project即可。</p><p><b>** 编写并使用UDF</b></p><p><b>*** 例如我们编写一个UDF函数，用来将制定字段内容转换为小写：</b></p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-2f9e667dca02b096.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-2f9e667dca02b096.png?imageMogr2/auto-orient/strip" data-image-slug="2f9e667dca02b096" data-width="700" data-height="489"><br><div class="image-caption"></div>
</div><p><b>*** 将程序打成jar包后，导入该jar</b></p><p>hive (default)&gt; add jar /home/z/Desktop/lower.jar;<br></p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-209943705e79c780.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-209943705e79c780.png?imageMogr2/auto-orient/strip" data-image-slug="209943705e79c780" data-width="1403" data-height="152"><br><div class="image-caption"></div>
</div><p><b>*** 创建临时函数：</b></p><p>hive (default)&gt; create temporary function my_lower as 'com.z.demo.udf.Lower';<br></p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-c8b5297c4a79cfbc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-c8b5297c4a79cfbc.png?imageMogr2/auto-orient/strip" data-image-slug="c8b5297c4a79cfbc" data-width="921" data-height="65"><br><div class="image-caption"></div>
</div><p><b>*** 使用该函数</b></p><p>hive (default)&gt; show fuctions ;<br></p><p>hive (default)&gt; select my_lower(ename) from db_emp_dept.emp;</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-e05acdffbbe3b54c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" data-original-src="http://upload-images.jianshu.io/upload_images/4951489-e05acdffbbe3b54c.png?imageMogr2/auto-orient/strip" data-image-slug="e05acdffbbe3b54c" data-width="1126" data-height="679"><br><div class="image-caption"></div>
</div><p><b>*** 注意事项：</b></p><p><b>**** </b>以上方式添加的UDF函数是临时生效的,只要退出当前hive窗口，便失效，一般不会设置永久生效。</p><p><b>****</b> 实际应用中,Hive会有多个Job任务，每个job任务都有自己对应的函数、以及hql语句; 每个job任务增加函数的语句和具体的业务分析语句一般会把它放到一个文件中(比如：job01.hql、job02.hql、job03.hql)，然后使用bin/hive -f job1.hql方式执行即可。<br></p><h1>* 总结</h1><p>本节主要讲解hive的一些高级用法，以及如何开发自定义函数用使用。</p><hr><p>个人微博：http://weibo.com/seal13<br></p><p>QQ大数据技术交流群（广告勿入）：476966007</p><div class="image-package">
<img src="http://upload-images.jianshu.io/upload_images/4951489-62ba58fe1377a8ce.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><br><div class="image-caption"></div>
</div><hr><p><a href="http://www.jianshu.com/p/dd19e15a4de0" target="_blank">下一节：Sqoop框架基础</a></p>
        </div>
      </div>
    </div>
  </body>
</html>
