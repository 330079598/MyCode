## çº¿ç¨‹
### è™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆä¸ºä»€ä¹ˆæ˜¯ç§æœ‰çš„ï¼Ÿ

- **è™šæ‹Ÿæœºæ ˆï¼š** æ¯ä¸ª Java æ–¹æ³•åœ¨æ‰§è¡Œä¹‹å‰ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ç”¨äºå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€å¸¸é‡æ± å¼•ç”¨ç­‰ä¿¡æ¯ã€‚ä»æ–¹æ³•è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæˆçš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨ Java è™šæ‹Ÿæœºæ ˆä¸­å…¥æ ˆå’Œå‡ºæ ˆçš„è¿‡ç¨‹ã€‚
- **æœ¬åœ°æ–¹æ³•æ ˆï¼š** å’Œè™šæ‹Ÿæœºæ ˆæ‰€å‘æŒ¥çš„ä½œç”¨éå¸¸ç›¸ä¼¼ï¼ŒåŒºåˆ«æ˜¯ï¼š**è™šæ‹Ÿæœºæ ˆä¸ºè™šæ‹Ÿæœºæ‰§è¡Œ Java æ–¹æ³• ï¼ˆä¹Ÿå°±æ˜¯å­—èŠ‚ç ï¼‰æœåŠ¡ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆåˆ™ä¸ºè™šæ‹Ÿæœºä½¿ç”¨åˆ°çš„ Native æ–¹æ³•æœåŠ¡ã€‚** åœ¨`HotSpot`è™šæ‹Ÿæœºä¸­å’Œ Java è™šæ‹Ÿæœºæ ˆåˆäºŒä¸ºä¸€ã€‚

æ‰€ä»¥ï¼Œä¸ºäº†**ä¿è¯çº¿ç¨‹ä¸­çš„å±€éƒ¨å˜é‡ä¸è¢«åˆ«çš„çº¿ç¨‹è®¿é—®åˆ°**ï¼Œè™šæ‹Ÿæœºæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚

### ä¸€å¥è¯ç®€å•äº†è§£å †å’Œæ–¹æ³•åŒº

å †å’Œæ–¹æ³•åŒºæ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„èµ„æºï¼Œå…¶ä¸­å †æ˜¯è¿›ç¨‹ä¸­æœ€å¤§çš„ä¸€å—å†…å­˜ï¼Œä¸»è¦ç”¨äºå­˜æ”¾æ–°åˆ›å»ºçš„å¯¹è±¡ (å‡ ä¹æ‰€æœ‰å¯¹è±¡éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜)ï¼Œæ–¹æ³•åŒºä¸»è¦ç”¨äºå­˜æ”¾å·²è¢«åŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç­‰æ•°æ®ã€‚

### çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€

Java çº¿ç¨‹åœ¨è¿è¡Œçš„ç”Ÿå‘½å‘¨æœŸä¸­çš„æŒ‡å®šæ—¶åˆ»åªå¯èƒ½å¤„äºä¸‹é¢ 6 ç§ä¸åŒçŠ¶æ€çš„å…¶ä¸­ä¸€ä¸ªçŠ¶æ€ï¼š

- NEW: åˆå§‹çŠ¶æ€ï¼Œçº¿ç¨‹è¢«åˆ›å»ºå‡ºæ¥ä½†æ²¡æœ‰è¢«è°ƒç”¨ `start()` ã€‚
- RUNNABLE: è¿è¡ŒçŠ¶æ€ï¼Œçº¿ç¨‹è¢«è°ƒç”¨äº† `start()`ç­‰å¾…è¿è¡Œçš„çŠ¶æ€ã€‚
- BLOCKEDï¼šé˜»å¡çŠ¶æ€ï¼Œéœ€è¦ç­‰å¾…é”é‡Šæ”¾ã€‚
- WAITINGï¼šç­‰å¾…çŠ¶æ€ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹éœ€è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹åšå‡ºä¸€äº›ç‰¹å®šåŠ¨ä½œï¼ˆé€šçŸ¥æˆ–ä¸­æ–­ï¼‰ã€‚
- TIME_WAITINGï¼šè¶…æ—¶ç­‰å¾…çŠ¶æ€ï¼Œå¯ä»¥åœ¨æŒ‡å®šçš„æ—¶é—´åè‡ªè¡Œè¿”å›è€Œä¸æ˜¯åƒ WAITING é‚£æ ·ä¸€ç›´ç­‰å¾…ã€‚
- TERMINATEDï¼šç»ˆæ­¢çŠ¶æ€ï¼Œè¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»è¿è¡Œå®Œæ¯•ã€‚

çº¿ç¨‹åœ¨ç”Ÿå‘½å‘¨æœŸä¸­å¹¶ä¸æ˜¯å›ºå®šå¤„äºæŸä¸€ä¸ªçŠ¶æ€è€Œæ˜¯éšç€ä»£ç çš„æ‰§è¡Œåœ¨ä¸åŒçŠ¶æ€ä¹‹é—´åˆ‡æ¢ã€‚

![thread-status](../images/thread-status.png)

ç”±ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼šçº¿ç¨‹åˆ›å»ºä¹‹åå®ƒå°†å¤„äº **NEWï¼ˆæ–°å»ºï¼‰** çŠ¶æ€ï¼Œè°ƒç”¨ `start()` æ–¹æ³•åå¼€å§‹è¿è¡Œï¼Œçº¿ç¨‹è¿™æ—¶å€™å¤„äº **READYï¼ˆå¯è¿è¡Œï¼‰** çŠ¶æ€ã€‚å¯è¿è¡ŒçŠ¶æ€çš„çº¿ç¨‹è·å¾—äº† CPU æ—¶é—´ç‰‡ï¼ˆtimesliceï¼‰åå°±å¤„äº **RUNNINGï¼ˆè¿è¡Œï¼‰** çŠ¶æ€ã€‚

> åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ï¼Œçº¿ç¨‹æœ‰ READY å’Œ RUNNING çŠ¶æ€ï¼›è€Œåœ¨ JVM å±‚é¢ï¼Œåªèƒ½çœ‹åˆ° RUNNABLE çŠ¶æ€ï¼ˆå›¾æºï¼š[HowToDoInJava](https://howtodoinJava.com/ "HowToDoInJava")ï¼š[Java Thread Life Cycle and Thread States](https://howtodoinJava.com/Java/multi-threading/Java-thread-life-cycle-and-thread-states/ "Java Thread Life Cycle and Thread States")ï¼‰ï¼Œæ‰€ä»¥ Java ç³»ç»Ÿä¸€èˆ¬å°†è¿™ä¸¤ä¸ªçŠ¶æ€ç»Ÿç§°ä¸º **RUNNABLEï¼ˆè¿è¡Œä¸­ï¼‰** çŠ¶æ€ ã€‚
**ä¸ºä»€ä¹ˆ JVM æ²¡æœ‰åŒºåˆ†è¿™ä¸¤ç§çŠ¶æ€å‘¢ï¼Ÿ** ï¼ˆæ‘˜è‡ªï¼š[Java çº¿ç¨‹è¿è¡Œæ€ä¹ˆæœ‰ç¬¬å…­ç§çŠ¶æ€ï¼Ÿ - Dawell çš„å›ç­”](https://www.zhihu.com/question/56494969/answer/154053599) ï¼‰ ç°åœ¨çš„æ—¶åˆ†ï¼ˆtime-sharingï¼‰å¤šä»»åŠ¡ï¼ˆmulti-taskï¼‰æ“ä½œç³»ç»Ÿæ¶æ„é€šå¸¸éƒ½æ˜¯ç”¨æ‰€è°“çš„â€œæ—¶é—´åˆ†ç‰‡ï¼ˆtime quantum or time sliceï¼‰â€æ–¹å¼è¿›è¡ŒæŠ¢å å¼ï¼ˆpreemptiveï¼‰è½®è½¬è°ƒåº¦ï¼ˆround-robin å¼ï¼‰ã€‚è¿™ä¸ªæ—¶é—´åˆ†ç‰‡é€šå¸¸æ˜¯å¾ˆå°çš„ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡æœ€å¤šåªèƒ½åœ¨ CPU ä¸Šè¿è¡Œæ¯”å¦‚ 10-20ms çš„æ—¶é—´ï¼ˆæ­¤æ—¶å¤„äº running çŠ¶æ€ï¼‰ï¼Œä¹Ÿå³å¤§æ¦‚åªæœ‰ 0.01 ç§’è¿™ä¸€é‡çº§ï¼Œæ—¶é—´ç‰‡ç”¨åå°±è¦è¢«åˆ‡æ¢ä¸‹æ¥æ”¾å…¥è°ƒåº¦é˜Ÿåˆ—çš„æœ«å°¾ç­‰å¾…å†æ¬¡è°ƒåº¦ã€‚ï¼ˆä¹Ÿå³å›åˆ° ready çŠ¶æ€ï¼‰ã€‚çº¿ç¨‹åˆ‡æ¢çš„å¦‚æ­¤ä¹‹å¿«ï¼ŒåŒºåˆ†è¿™ä¸¤ç§çŠ¶æ€å°±æ²¡ä»€ä¹ˆæ„ä¹‰äº†ã€‚

- å½“çº¿ç¨‹æ‰§è¡Œ `wait()`æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹è¿›å…¥ **WAITINGï¼ˆç­‰å¾…ï¼‰** çŠ¶æ€ã€‚è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹éœ€è¦ä¾é å…¶ä»–çº¿ç¨‹çš„é€šçŸ¥æ‰èƒ½å¤Ÿè¿”å›åˆ°è¿è¡ŒçŠ¶æ€ã€‚
- **TIMED_WAITING(è¶…æ—¶ç­‰å¾…)** çŠ¶æ€ç›¸å½“äºåœ¨ç­‰å¾…çŠ¶æ€çš„åŸºç¡€ä¸Šå¢åŠ äº†è¶…æ—¶é™åˆ¶ï¼Œæ¯”å¦‚é€šè¿‡ `sleepï¼ˆlong millisï¼‰`æ–¹æ³•æˆ– `waitï¼ˆlong millisï¼‰`æ–¹æ³•å¯ä»¥å°†çº¿ç¨‹ç½®äº TIMED_WAITING çŠ¶æ€ã€‚å½“è¶…æ—¶æ—¶é—´ç»“æŸåï¼Œçº¿ç¨‹å°†ä¼šè¿”å›åˆ° RUNNABLE çŠ¶æ€ã€‚
- å½“çº¿ç¨‹è¿›å…¥ `synchronized` æ–¹æ³•/å—æˆ–è€…è°ƒç”¨ `wait` åï¼ˆè¢« `notify`ï¼‰é‡æ–°è¿›å…¥ `synchronized` æ–¹æ³•/å—ï¼Œä½†æ˜¯é”è¢«å…¶å®ƒçº¿ç¨‹å æœ‰ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹å°±ä¼šè¿›å…¥ **BLOCKEDï¼ˆé˜»å¡ï¼‰** çŠ¶æ€ã€‚
- çº¿ç¨‹åœ¨æ‰§è¡Œå®Œäº† `run()`æ–¹æ³•ä¹‹åå°†ä¼šè¿›å…¥åˆ° **TERMINATEDï¼ˆç»ˆæ­¢ï¼‰** çŠ¶æ€ã€‚

### `Thread#sleep()`æ–¹æ³•å’Œ`Object#wait()`æ–¹æ³•å¯¹æ¯”

**å…±åŒç‚¹**ï¼š ä¸¤è€…éƒ½å¯ä»¥æš‚åœçº¿ç¨‹çš„æ‰§è¡Œ

**åŒºåˆ«**ï¼š
- **`sleep()` æ–¹æ³•æ²¡æœ‰é‡Šæ”¾é”ï¼Œè€Œ `wait()` æ–¹æ³•é‡Šæ”¾äº†é”** ã€‚
- `wait()` é€šå¸¸è¢«ç”¨äºçº¿ç¨‹é—´äº¤äº’/é€šä¿¡ï¼Œ`sleep()`é€šå¸¸è¢«ç”¨äºæš‚åœæ‰§è¡Œã€‚
- `wait()` æ–¹æ³•è¢«è°ƒç”¨åï¼Œçº¿ç¨‹ä¸ä¼šè‡ªåŠ¨è‹é†’ï¼Œéœ€è¦åˆ«çš„çº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªå¯¹è±¡ä¸Šçš„ `notify()`æˆ–è€… `notifyAll()` æ–¹æ³•ã€‚`sleep()`æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ `wait(long timeout)` è¶…æ—¶åçº¿ç¨‹ä¼šè‡ªåŠ¨è‹é†’ã€‚
- `sleep()` æ˜¯ `Thread` ç±»çš„é™æ€æœ¬åœ°æ–¹æ³•ï¼Œ`wait()` åˆ™æ˜¯ `Object` ç±»çš„æœ¬åœ°æ–¹æ³•ã€‚ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡å‘¢ï¼Ÿä¸‹ä¸€ä¸ªé—®é¢˜å°±ä¼šèŠåˆ°ã€‚

### ä¸ºä»€ä¹ˆ`wati()`æ–¹æ³•ä¸å®šä¹‰åœ¨`Thread`ä¸­ï¼Ÿ

`wait()` æ˜¯è®©è·å¾—å¯¹è±¡é”çš„çº¿ç¨‹å®ç°ç­‰å¾…ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„å¯¹è±¡é”ã€‚æ¯ä¸ªå¯¹è±¡ï¼ˆ`Object`ï¼‰éƒ½æ‹¥æœ‰å¯¹è±¡é”ï¼Œæ—¢ç„¶è¦é‡Šæ”¾å½“å‰çº¿ç¨‹å æœ‰çš„å¯¹è±¡é”å¹¶è®©å…¶è¿›å…¥ WAITING çŠ¶æ€ï¼Œè‡ªç„¶æ˜¯è¦æ“ä½œå¯¹åº”çš„å¯¹è±¡ï¼ˆ`Object`ï¼‰è€Œéå½“å‰çš„çº¿ç¨‹ï¼ˆ`Thread`ï¼‰ã€‚

ç±»ä¼¼çš„é—®é¢˜ï¼š**ä¸ºä»€ä¹ˆ `sleep()` æ–¹æ³•å®šä¹‰åœ¨ `Thread` ä¸­ï¼Ÿ**

å› ä¸º `sleep()` æ˜¯è®©å½“å‰çº¿ç¨‹æš‚åœæ‰§è¡Œï¼Œä¸æ¶‰åŠåˆ°å¯¹è±¡ç±»ï¼Œä¹Ÿä¸éœ€è¦è·å¾—å¯¹è±¡é”ã€‚

### å¯ä»¥ç›´æ¥è°ƒç”¨`Thread`ä¸­çš„`run`æ–¹æ³•ä¹ˆï¼Ÿ

new ä¸€ä¸ª `Thread`ï¼Œçº¿ç¨‹è¿›å…¥äº†æ–°å»ºçŠ¶æ€ã€‚è°ƒç”¨ `start()`æ–¹æ³•ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥äº†å°±ç»ªçŠ¶æ€ï¼Œå½“åˆ†é…åˆ°æ—¶é—´ç‰‡åå°±å¯ä»¥å¼€å§‹è¿è¡Œäº†ã€‚ `start()` ä¼šæ‰§è¡Œçº¿ç¨‹çš„ç›¸åº”å‡†å¤‡å·¥ä½œï¼Œç„¶åè‡ªåŠ¨æ‰§è¡Œ `run()` æ–¹æ³•çš„å†…å®¹ï¼Œè¿™æ˜¯çœŸæ­£çš„å¤šçº¿ç¨‹å·¥ä½œã€‚ ä½†æ˜¯ï¼Œç›´æ¥æ‰§è¡Œ `run()` æ–¹æ³•ï¼Œä¼šæŠŠ `run()` æ–¹æ³•å½“æˆä¸€ä¸ª main çº¿ç¨‹ä¸‹çš„æ™®é€šæ–¹æ³•å»æ‰§è¡Œï¼Œå¹¶ä¸ä¼šåœ¨æŸä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œå®ƒï¼Œæ‰€ä»¥è¿™å¹¶ä¸æ˜¯å¤šçº¿ç¨‹å·¥ä½œã€‚

**æ€»ç»“ï¼šè°ƒç”¨ `start()` æ–¹æ³•æ–¹å¯å¯åŠ¨çº¿ç¨‹å¹¶ä½¿çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œç›´æ¥æ‰§è¡Œ `run()` æ–¹æ³•çš„è¯ä¸ä¼šä»¥å¤šçº¿ç¨‹çš„æ–¹å¼æ‰§è¡Œã€‚**

## å¤šçº¿ç¨‹

### å¹¶å‘è¯­å¹¶è¡Œçš„åŒºåˆ«

- **å¹¶å‘**ï¼šä¸¤ä¸ªåŠä¸¤ä¸ªä»¥ä¸Šçš„ä½œä¸šåœ¨åŒä¸€Â **æ—¶é—´æ®µ**Â å†…æ‰§è¡Œã€‚
- **å¹¶è¡Œ**ï¼šä¸¤ä¸ªåŠä¸¤ä¸ªä»¥ä¸Šçš„ä½œä¸šåœ¨åŒä¸€Â **æ—¶åˆ»**Â æ‰§è¡Œã€‚
æœ€å…³é”®çš„ç‚¹æ˜¯ï¼šæ˜¯å¦æ˜¯Â **åŒæ—¶**Â æ‰§è¡Œã€‚

### åŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«

- **åŒæ­¥**ï¼šå‘å‡ºä¸€ä¸ªè°ƒç”¨ä¹‹åï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œ è¯¥è°ƒç”¨å°±ä¸å¯ä»¥è¿”å›ï¼Œä¸€ç›´ç­‰å¾…ã€‚
- **å¼‚æ­¥**ï¼šè°ƒç”¨åœ¨å‘å‡ºä¹‹åï¼Œä¸ç”¨ç­‰å¾…è¿”å›ç»“æœï¼Œè¯¥è°ƒç”¨ç›´æ¥è¿”å›ã€‚

### ğŸŒŸä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ

å…ˆä»æ€»ä½“ä¸Šæ¥è¯´ï¼š

- **ä»è®¡ç®—æœºåº•å±‚æ¥è¯´ï¼š** çº¿ç¨‹å¯ä»¥æ¯”ä½œæ˜¯è½»é‡çº§çš„è¿›ç¨‹ï¼Œæ˜¯ç¨‹åºæ‰§è¡Œçš„æœ€å°å•ä½,çº¿ç¨‹é—´çš„åˆ‡æ¢å’Œè°ƒåº¦çš„æˆæœ¬è¿œè¿œå°äºè¿›ç¨‹ã€‚å¦å¤–ï¼Œå¤šæ ¸ CPU æ—¶ä»£æ„å‘³ç€å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¿è¡Œï¼Œè¿™å‡å°‘äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚
- **ä»å½“ä»£äº’è”ç½‘å‘å±•è¶‹åŠ¿æ¥è¯´ï¼š** ç°åœ¨çš„ç³»ç»ŸåŠ¨ä¸åŠ¨å°±è¦æ±‚ç™¾ä¸‡çº§ç”šè‡³åƒä¸‡çº§çš„å¹¶å‘é‡ï¼Œè€Œå¤šçº¿ç¨‹å¹¶å‘ç¼–ç¨‹æ­£æ˜¯å¼€å‘é«˜å¹¶å‘ç³»ç»Ÿçš„åŸºç¡€ï¼Œåˆ©ç”¨å¥½å¤šçº¿ç¨‹æœºåˆ¶å¯ä»¥å¤§å¤§æé«˜ç³»ç»Ÿæ•´ä½“çš„å¹¶å‘èƒ½åŠ›ä»¥åŠæ€§èƒ½ã€‚

å†æ·±å…¥åˆ°è®¡ç®—æœºåº•å±‚æ¥æ¢è®¨ï¼š

- **å•æ ¸æ—¶ä»£**ï¼šåœ¨å•æ ¸æ—¶ä»£å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜å•è¿›ç¨‹åˆ©ç”¨ CPU å’Œ IO ç³»ç»Ÿçš„æ•ˆç‡ã€‚ å‡è®¾åªè¿è¡Œäº†ä¸€ä¸ª Java è¿›ç¨‹çš„æƒ…å†µï¼Œå½“æˆ‘ä»¬è¯·æ±‚ IO çš„æ—¶å€™ï¼Œå¦‚æœ Java è¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œæ­¤çº¿ç¨‹è¢« IO é˜»å¡åˆ™æ•´ä¸ªè¿›ç¨‹è¢«é˜»å¡ã€‚CPU å’Œ IO è®¾å¤‡åªæœ‰ä¸€ä¸ªåœ¨è¿è¡Œï¼Œé‚£ä¹ˆå¯ä»¥ç®€å•åœ°è¯´ç³»ç»Ÿæ•´ä½“æ•ˆç‡åªæœ‰ 50%ã€‚å½“ä½¿ç”¨å¤šçº¿ç¨‹çš„æ—¶å€™ï¼Œä¸€ä¸ªçº¿ç¨‹è¢« IO é˜»å¡ï¼Œå…¶ä»–çº¿ç¨‹è¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨ CPUã€‚ä»è€Œæé«˜äº† Java è¿›ç¨‹åˆ©ç”¨ç³»ç»Ÿèµ„æºçš„æ•´ä½“æ•ˆç‡ã€‚
- **å¤šæ ¸æ—¶ä»£**: å¤šæ ¸æ—¶ä»£å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜è¿›ç¨‹åˆ©ç”¨å¤šæ ¸ CPU çš„èƒ½åŠ›ã€‚ä¸¾ä¸ªä¾‹å­ï¼šå‡å¦‚æˆ‘ä»¬è¦è®¡ç®—ä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬åªç”¨ä¸€ä¸ªçº¿ç¨‹çš„è¯ï¼Œä¸è®ºç³»ç»Ÿæœ‰å‡ ä¸ª CPU æ ¸å¿ƒï¼Œéƒ½åªä¼šæœ‰ä¸€ä¸ª CPU æ ¸å¿ƒè¢«åˆ©ç”¨åˆ°ã€‚è€Œåˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹å¯ä»¥è¢«æ˜ å°„åˆ°åº•å±‚å¤šä¸ª CPU æ ¸å¿ƒä¸Šæ‰§è¡Œï¼Œåœ¨ä»»åŠ¡ä¸­çš„å¤šä¸ªçº¿ç¨‹æ²¡æœ‰èµ„æºç«äº‰çš„æƒ…å†µä¸‹ï¼Œä»»åŠ¡æ‰§è¡Œçš„æ•ˆç‡ä¼šæœ‰æ˜¾è‘—æ€§çš„æé«˜ï¼Œçº¦ç­‰äºï¼ˆå•æ ¸æ—¶æ‰§è¡Œæ—¶é—´/CPU æ ¸å¿ƒæ•°ï¼‰ã€‚

### å•æ ¸`CPU`æ”¯æŒ`Java`å¤šçº¿ç¨‹ä¹ˆï¼Ÿ

å•æ ¸ CPU æ˜¯æ”¯æŒ Java å¤šçº¿ç¨‹çš„ã€‚æ“ä½œç³»ç»Ÿé€šè¿‡æ—¶é—´ç‰‡è½®è½¬çš„æ–¹å¼ï¼Œå°† CPU çš„æ—¶é—´åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ã€‚å°½ç®¡å•æ ¸ CPU ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œä½†é€šè¿‡å¿«é€Ÿåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´åˆ‡æ¢ï¼Œå¯ä»¥è®©ç”¨æˆ·æ„Ÿè§‰å¤šä¸ªä»»åŠ¡æ˜¯åŒæ—¶è¿›è¡Œçš„ã€‚

è¿™é‡Œé¡ºå¸¦æä¸€ä¸‹ Java ä½¿ç”¨çš„çº¿ç¨‹è°ƒåº¦æ–¹å¼ã€‚

æ“ä½œç³»ç»Ÿä¸»è¦é€šè¿‡ä¸¤ç§çº¿ç¨‹è°ƒåº¦æ–¹å¼æ¥ç®¡ç†å¤šçº¿ç¨‹çš„æ‰§è¡Œï¼š

- **æŠ¢å å¼è°ƒåº¦ï¼ˆPreemptive Schedulingï¼‰**ï¼šæ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶æš‚åœå½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œå¹¶åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚è¿™ç§åˆ‡æ¢é€šå¸¸æ˜¯ç”±ç³»ç»Ÿæ—¶é’Ÿä¸­æ–­ï¼ˆæ—¶é—´ç‰‡è½®è½¬ï¼‰æˆ–å…¶ä»–é«˜ä¼˜å…ˆçº§äº‹ä»¶ï¼ˆå¦‚ I/O æ“ä½œå®Œæˆï¼‰è§¦å‘çš„ã€‚è¿™ç§æ–¹å¼å­˜åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Œä½†å…¬å¹³æ€§å’Œ CPU èµ„æºåˆ©ç”¨ç‡è¾ƒå¥½ï¼Œä¸æ˜“é˜»å¡ã€‚
- **ååŒå¼è°ƒåº¦ï¼ˆCooperative Schedulingï¼‰**ï¼šçº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œä¸»åŠ¨é€šçŸ¥ç³»ç»Ÿåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™ç§æ–¹å¼å¯ä»¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢å¸¦æ¥çš„æ€§èƒ½å¼€é”€ï¼Œä½†å…¬å¹³æ€§è¾ƒå·®ï¼Œå®¹æ˜“é˜»å¡ã€‚

Java ä½¿ç”¨çš„çº¿ç¨‹è°ƒåº¦æ˜¯æŠ¢å å¼çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒJVM æœ¬èº«ä¸è´Ÿè´£çº¿ç¨‹çš„è°ƒåº¦ï¼Œè€Œæ˜¯å°†çº¿ç¨‹çš„è°ƒåº¦å§”æ‰˜ç»™æ“ä½œç³»ç»Ÿã€‚æ“ä½œç³»ç»Ÿé€šå¸¸ä¼šåŸºäºçº¿ç¨‹ä¼˜å…ˆçº§å’Œæ—¶é—´ç‰‡æ¥è°ƒåº¦çº¿ç¨‹çš„æ‰§è¡Œï¼Œé«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹é€šå¸¸è·å¾— CPU æ—¶é—´ç‰‡çš„æœºä¼šæ›´å¤šã€‚

### ğŸŒŸå•æ ¸`CPU`ä¸Šè¿è¡Œå¤šä¸ªçº¿ç¨‹æ•ˆç‡ä¸€å®šä¼šé«˜ä¹ˆï¼Ÿ

å•æ ¸ CPU åŒæ—¶è¿è¡Œå¤šä¸ªçº¿ç¨‹çš„æ•ˆç‡æ˜¯å¦ä¼šé«˜ï¼Œå–å†³äºçº¿ç¨‹çš„ç±»å‹å’Œä»»åŠ¡çš„æ€§è´¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæœ‰ä¸¤ç§ç±»å‹çš„çº¿ç¨‹ï¼š

1. **CPU å¯†é›†å‹**ï¼šCPU å¯†é›†å‹çš„çº¿ç¨‹ä¸»è¦è¿›è¡Œè®¡ç®—å’Œé€»è¾‘å¤„ç†ï¼Œéœ€è¦å ç”¨å¤§é‡çš„ CPU èµ„æºã€‚
2. **IO å¯†é›†å‹**ï¼šIO å¯†é›†å‹çš„çº¿ç¨‹ä¸»è¦è¿›è¡Œè¾“å…¥è¾“å‡ºæ“ä½œï¼Œå¦‚è¯»å†™æ–‡ä»¶ã€ç½‘ç»œé€šä¿¡ç­‰ï¼Œéœ€è¦ç­‰å¾… IO è®¾å¤‡çš„å“åº”ï¼Œè€Œä¸å ç”¨å¤ªå¤šçš„ CPU èµ„æºã€‚

åœ¨å•æ ¸ CPU ä¸Šï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡Œï¼Œå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾… CPU çš„æ—¶é—´ç‰‡åˆ†é…ã€‚å¦‚æœçº¿ç¨‹æ˜¯ CPU å¯†é›†å‹çš„ï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œä¼šå¯¼è‡´é¢‘ç¹çš„çº¿ç¨‹åˆ‡æ¢ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å¼€é”€ï¼Œé™ä½äº†æ•ˆç‡ã€‚å¦‚æœçº¿ç¨‹æ˜¯ IO å¯†é›†å‹çš„ï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œå¯ä»¥åˆ©ç”¨ CPU åœ¨ç­‰å¾… IO æ—¶çš„ç©ºé—²æ—¶é—´ï¼Œæé«˜äº†æ•ˆç‡ã€‚

å› æ­¤ï¼Œå¯¹äºå•æ ¸ CPU æ¥è¯´ï¼Œå¦‚æœä»»åŠ¡æ˜¯ CPU å¯†é›†å‹çš„ï¼Œé‚£ä¹ˆå¼€å¾ˆå¤šçº¿ç¨‹ä¼šå½±å“æ•ˆç‡ï¼›å¦‚æœä»»åŠ¡æ˜¯ IO å¯†é›†å‹çš„ï¼Œé‚£ä¹ˆå¼€å¾ˆå¤šçº¿ç¨‹ä¼šæé«˜æ•ˆç‡ã€‚å½“ç„¶ï¼Œè¿™é‡Œçš„â€œå¾ˆå¤šâ€ä¹Ÿè¦é€‚åº¦ï¼Œä¸èƒ½è¶…è¿‡ç³»ç»Ÿèƒ½å¤Ÿæ‰¿å—çš„ä¸Šé™ã€‚

## ğŸŒŸæ­»é”

### ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ

çº¿ç¨‹æ­»é”æè¿°çš„æ˜¯è¿™æ ·ä¸€ç§æƒ…å†µï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«é˜»å¡ï¼Œå®ƒä»¬ä¸­çš„ä¸€ä¸ªæˆ–è€…å…¨éƒ¨éƒ½åœ¨ç­‰å¾…æŸä¸ªèµ„æºè¢«é‡Šæ”¾ã€‚ç”±äºçº¿ç¨‹è¢«æ— é™æœŸåœ°é˜»å¡ï¼Œå› æ­¤ç¨‹åºä¸å¯èƒ½æ­£å¸¸ç»ˆæ­¢ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¿ç¨‹ A æŒæœ‰èµ„æº 2ï¼Œçº¿ç¨‹ B æŒæœ‰èµ„æº 1ï¼Œä»–ä»¬åŒæ—¶éƒ½æƒ³ç”³è¯·å¯¹æ–¹çš„èµ„æºï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šäº’ç›¸ç­‰å¾…è€Œè¿›å…¥æ­»é”çŠ¶æ€ã€‚

![ä»€ä¹ˆæ˜¯æ­»é”](../images/2019-4æ­»é”1.png)

ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜çº¿ç¨‹æ­»é”,ä»£ç æ¨¡æ‹Ÿäº†ä¸Šå›¾çš„æ­»é”çš„æƒ…å†µ (ä»£ç æ¥æºäºã€Šå¹¶å‘ç¼–ç¨‹ä¹‹ç¾ã€‹)ï¼š

```java
public class DeadLockDemo {
    private static Object resource1 = new Object();//èµ„æº 1
    private static Object resource2 = new Object();//èµ„æº 2

    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (resource1) {
                System.out.println(Thread.currentThread() + "get resource1");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource2");
                synchronized (resource2) {
                    System.out.println(Thread.currentThread() + "get resource2");
                }
            }
        }, "çº¿ç¨‹ 1").start();

        new Thread(() -> {
            synchronized (resource2) {
                System.out.println(Thread.currentThread() + "get resource2");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println(Thread.currentThread() + "waiting get resource1");
                synchronized (resource1) {
                    System.out.println(Thread.currentThread() + "get resource1");
                }
            }
        }, "çº¿ç¨‹ 2").start();
    }
}
```

Output

```
Thread[çº¿ç¨‹ 1,5,main]get resource1
Thread[çº¿ç¨‹ 2,5,main]get resource2
Thread[çº¿ç¨‹ 1,5,main]waiting get resource2
Thread[çº¿ç¨‹ 2,5,main]waiting get resource1
```

çº¿ç¨‹ A é€šè¿‡ `synchronized (resource1)` è·å¾— `resource1` çš„ç›‘è§†å™¨é”ï¼Œç„¶åé€šè¿‡`Thread.sleep(1000);`è®©çº¿ç¨‹ A ä¼‘çœ  1s ä¸ºçš„æ˜¯è®©çº¿ç¨‹ B å¾—åˆ°æ‰§è¡Œç„¶åè·å–åˆ° resource2 çš„ç›‘è§†å™¨é”ã€‚çº¿ç¨‹ A å’Œçº¿ç¨‹ B ä¼‘çœ ç»“æŸäº†éƒ½å¼€å§‹ä¼å›¾è¯·æ±‚è·å–å¯¹æ–¹çš„èµ„æºï¼Œç„¶åè¿™ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šé™·å…¥äº’ç›¸ç­‰å¾…çš„çŠ¶æ€ï¼Œè¿™ä¹Ÿå°±äº§ç”Ÿäº†æ­»é”ã€‚

ä¸Šé¢çš„ä¾‹å­ç¬¦åˆ**äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶**ï¼š

1. **äº’æ–¥æ¡ä»¶**ï¼šè¯¥èµ„æºä»»æ„ä¸€ä¸ªæ—¶åˆ»åªç”±ä¸€ä¸ªçº¿ç¨‹å ç”¨ã€‚
2. **è¯·æ±‚ä¸ä¿æŒæ¡ä»¶**ï¼šä¸€ä¸ªçº¿ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚
3. **ä¸å‰¥å¤ºæ¡ä»¶**ï¼šçº¿ç¨‹å·²è·å¾—çš„èµ„æºåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å¼ºè¡Œå‰¥å¤ºï¼Œåªæœ‰è‡ªå·±ä½¿ç”¨å®Œæ¯•åæ‰é‡Šæ”¾èµ„æºã€‚
4. **å¾ªç¯ç­‰å¾…æ¡ä»¶**ï¼šè‹¥å¹²çº¿ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚

### `volatile`å¯ä»¥ä¿è¯åŸå­æ€§ä¹ˆï¼Ÿ

**`volatile`Â å…³é”®å­—èƒ½ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯å¯¹å˜é‡çš„æ“ä½œæ˜¯åŸå­æ€§çš„ã€‚**

```java
public class VolatileAtomicityDemo {
    public volatile static int inc = 0;

    public void increase() {
        inc++;
    }

    public static void main(String[] args) throws InterruptedException {
        ExecutorService threadPool = Executors.newFixedThreadPool(5);
        VolatileAtomicityDemo volatileAtomicityDemo = new VolatileAtomicityDemo();
        for (int i = 0; i < 5; i++) {
            threadPool.execute(() -> {
                for (int j = 0; j < 500; j++) {
                    volatileAtomicityDemo.increase();
                }
            });
        }
        // ç­‰å¾…1.5ç§’ï¼Œä¿è¯ä¸Šé¢ç¨‹åºæ‰§è¡Œå®Œæˆ
        Thread.sleep(1500);
        System.out.println(inc);
        threadPool.shutdown();
    }
}
```

æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿è¡Œä¸Šé¢çš„ä»£ç ç†åº”è¾“å‡º `2500`ã€‚ä½†ä½ çœŸæ­£è¿è¡Œäº†ä¸Šé¢çš„ä»£ç ä¹‹åï¼Œä½ ä¼šå‘ç°æ¯æ¬¡è¾“å‡ºç»“æœéƒ½å°äº `2500`ã€‚

ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿä¸æ˜¯è¯´å¥½äº†ï¼Œ`volatile` å¯ä»¥ä¿è¯å˜é‡çš„å¯è§æ€§å˜›ï¼

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ `volatile` èƒ½ä¿è¯ `inc++` æ“ä½œçš„åŸå­æ€§çš„è¯ã€‚æ¯ä¸ªçº¿ç¨‹ä¸­å¯¹ `inc` å˜é‡è‡ªå¢å®Œä¹‹åï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥ç«‹å³çœ‹åˆ°ä¿®æ”¹åçš„å€¼ã€‚5 ä¸ªçº¿ç¨‹åˆ†åˆ«è¿›è¡Œäº† 500 æ¬¡æ“ä½œï¼Œé‚£ä¹ˆæœ€ç»ˆ inc çš„å€¼åº”è¯¥æ˜¯ 5*500=2500ã€‚

å¾ˆå¤šäººä¼šè¯¯è®¤ä¸ºè‡ªå¢æ“ä½œ `inc++` æ˜¯åŸå­æ€§çš„ï¼Œå®é™…ä¸Šï¼Œ`inc++` å…¶å®æ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼ŒåŒ…æ‹¬ä¸‰æ­¥ï¼š

1. è¯»å– inc çš„å€¼ã€‚
2. å¯¹ inc åŠ  1ã€‚
3. å°† inc çš„å€¼å†™å›å†…å­˜ã€‚

`volatile` æ˜¯æ— æ³•ä¿è¯è¿™ä¸‰ä¸ªæ“ä½œæ˜¯å…·æœ‰åŸå­æ€§çš„ï¼Œæœ‰å¯èƒ½å¯¼è‡´ä¸‹é¢è¿™ç§æƒ…å†µå‡ºç°ï¼š

4. çº¿ç¨‹ 1 å¯¹ `inc` è¿›è¡Œè¯»å–æ“ä½œä¹‹åï¼Œè¿˜æœªå¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚çº¿ç¨‹ 2 åˆè¯»å–äº† `inc`çš„å€¼å¹¶å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼ˆ+1ï¼‰ï¼Œå†å°†`inc` çš„å€¼å†™å›å†…å­˜ã€‚
5. çº¿ç¨‹ 2 æ“ä½œå®Œæ¯•åï¼Œçº¿ç¨‹ 1 å¯¹ `inc`çš„å€¼è¿›è¡Œä¿®æ”¹ï¼ˆ+1ï¼‰ï¼Œå†å°†`inc` çš„å€¼å†™å›å†…å­˜ã€‚

è¿™ä¹Ÿå°±å¯¼è‡´ä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«å¯¹ `inc` è¿›è¡Œäº†ä¸€æ¬¡è‡ªå¢æ“ä½œåï¼Œ`inc` å®é™…ä¸Šåªå¢åŠ äº† 1ã€‚

å…¶å®ï¼Œå¦‚æœæƒ³è¦ä¿è¯ä¸Šé¢çš„ä»£ç è¿è¡Œæ­£ç¡®ä¹Ÿéå¸¸ç®€å•ï¼Œåˆ©ç”¨ `synchronized`ã€`Lock`æˆ–è€…`AtomicInteger`éƒ½å¯ä»¥ã€‚

ä½¿ç”¨ `synchronized` æ”¹è¿›ï¼š

```java
public synchronized void increase() {
    inc++;
}
```

ä½¿ç”¨Â `AtomicInteger`Â æ”¹è¿›ï¼š

```java
public AtomicInteger inc = new AtomicInteger();

public void increase() {
    inc.getAndIncrement();
}
```

ä½¿ç”¨Â `ReentrantLock`Â æ”¹è¿›ï¼š

```java
Lock lock = new ReentrantLock();
public void increase() {
    lock.lock();
    try {
        inc++;
    } finally {
        lock.unlock();
    }
}
```

## ğŸŒŸä¹è§‚é”å’Œæ‚²è§‚é”

### ä»€ä¹ˆæ˜¯æ‚²è§‚é”ï¼Ÿ

æ‚²è§‚é”æ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œè®¤ä¸ºå…±äº«èµ„æºæ¯æ¬¡è¢«è®¿é—®çš„æ—¶å€™å°±ä¼šå‡ºç°é—®é¢˜(æ¯”å¦‚å…±äº«æ•°æ®è¢«ä¿®æ”¹)ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨è·å–èµ„æºæ“ä½œçš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·å…¶ä»–çº¿ç¨‹æƒ³æ‹¿åˆ°è¿™ä¸ªèµ„æºå°±ä¼šé˜»å¡ç›´åˆ°é”è¢«ä¸Šä¸€ä¸ªæŒæœ‰è€…é‡Šæ”¾ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**å…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹**ã€‚

åƒ Java ä¸­`synchronized`å’Œ`ReentrantLock`ç­‰ç‹¬å é”å°±æ˜¯æ‚²è§‚é”æ€æƒ³çš„å®ç°ã€‚

```java
public void performSynchronisedTask() {
    synchronized (this) {
        // éœ€è¦åŒæ­¥çš„æ“ä½œ
    }
}

private Lock lock = new ReentrantLock();
lock.lock();
try {
   // éœ€è¦åŒæ­¥çš„æ“ä½œ
} finally {
    lock.unlock();
}
```

é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œæ¿€çƒˆçš„é”ç«äº‰ä¼šé€ æˆçº¿ç¨‹é˜»å¡ï¼Œå¤§é‡é˜»å¡çº¿ç¨‹ä¼šå¯¼è‡´ç³»ç»Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¢åŠ ç³»ç»Ÿçš„æ€§èƒ½å¼€é”€ã€‚å¹¶ä¸”ï¼Œæ‚²è§‚é”è¿˜å¯èƒ½ä¼šå­˜åœ¨æ­»é”é—®é¢˜ï¼Œå½±å“ä»£ç çš„æ­£å¸¸è¿è¡Œã€‚

### ä»€ä¹ˆæ˜¯ä¹è§‚é”ï¼Ÿ

ä¹è§‚é”æ€»æ˜¯å‡è®¾æœ€å¥½çš„æƒ…å†µï¼Œè®¤ä¸ºå…±äº«èµ„æºæ¯æ¬¡è¢«è®¿é—®çš„æ—¶å€™ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œçº¿ç¨‹å¯ä»¥ä¸åœåœ°æ‰§è¡Œï¼Œæ— éœ€åŠ é”ä¹Ÿæ— éœ€ç­‰å¾…ï¼Œåªæ˜¯åœ¨æäº¤ä¿®æ”¹çš„æ—¶å€™å»éªŒè¯å¯¹åº”çš„èµ„æºï¼ˆä¹Ÿå°±æ˜¯æ•°æ®ï¼‰æ˜¯å¦è¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹äº†ï¼ˆå…·ä½“æ–¹æ³•å¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ– CAS ç®—æ³•ï¼‰ã€‚

åœ¨ Java ä¸­`java.util.concurrent.atomic`åŒ…ä¸‹é¢çš„åŸå­å˜é‡ç±»ï¼ˆæ¯”å¦‚`AtomicInteger`ã€`LongAdder`ï¼‰å°±æ˜¯ä½¿ç”¨äº†ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ **CAS** å®ç°çš„ã€‚

![atomic](../images/atomic.png)

```java
// LongAdder åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¼šæ¯” AtomicInteger å’Œ AtomicLong çš„æ€§èƒ½æ›´å¥½
// ä»£ä»·å°±æ˜¯ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ç©ºé—´ï¼ˆç©ºé—´æ¢æ—¶é—´ï¼‰
LongAdder sum = new LongAdder();
sum.increment();
```

é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œä¹è§‚é”ç›¸æ¯”æ‚²è§‚é”æ¥è¯´ï¼Œä¸å­˜åœ¨é”ç«äº‰é€ æˆçº¿ç¨‹é˜»å¡ï¼Œä¹Ÿä¸ä¼šæœ‰æ­»é”çš„é—®é¢˜ï¼Œåœ¨æ€§èƒ½ä¸Šå¾€å¾€ä¼šæ›´èƒœä¸€ç­¹ã€‚ä½†æ˜¯ï¼Œå¦‚æœå†²çªé¢‘ç¹å‘ç”Ÿï¼ˆå†™å æ¯”éå¸¸å¤šçš„æƒ…å†µï¼‰ï¼Œä¼šé¢‘ç¹å¤±è´¥å’Œé‡è¯•ï¼Œè¿™æ ·åŒæ ·ä¼šéå¸¸å½±å“æ€§èƒ½ï¼Œå¯¼è‡´ CPU é£™å‡ã€‚

ä¸è¿‡ï¼Œå¤§é‡å¤±è´¥é‡è¯•çš„é—®é¢˜ä¹Ÿæ˜¯å¯ä»¥è§£å†³çš„ï¼Œåƒæˆ‘ä»¬å‰é¢æåˆ°çš„ `LongAdder`ä»¥ç©ºé—´æ¢æ—¶é—´çš„æ–¹å¼å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚

ç†è®ºä¸Šæ¥è¯´ï¼š

- æ‚²è§‚é”é€šå¸¸å¤šç”¨äºå†™æ¯”è¾ƒå¤šçš„æƒ…å†µï¼ˆå¤šå†™åœºæ™¯ï¼Œç«äº‰æ¿€çƒˆï¼‰ï¼Œè¿™æ ·å¯ä»¥é¿å…é¢‘ç¹å¤±è´¥å’Œé‡è¯•å½±å“æ€§èƒ½ï¼Œæ‚²è§‚é”çš„å¼€é”€æ˜¯å›ºå®šçš„ã€‚ä¸è¿‡ï¼Œå¦‚æœä¹è§‚é”è§£å†³äº†é¢‘ç¹å¤±è´¥å’Œé‡è¯•è¿™ä¸ªé—®é¢˜çš„è¯ï¼ˆæ¯”å¦‚`LongAdder`ï¼‰ï¼Œä¹Ÿæ˜¯å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¹è§‚é”çš„ï¼Œè¦è§†å®é™…æƒ…å†µè€Œå®šã€‚
- ä¹è§‚é”é€šå¸¸å¤šç”¨äºå†™æ¯”è¾ƒå°‘çš„æƒ…å†µï¼ˆå¤šè¯»åœºæ™¯ï¼Œç«äº‰è¾ƒå°‘ï¼‰ï¼Œè¿™æ ·å¯ä»¥é¿å…é¢‘ç¹åŠ é”å½±å“æ€§èƒ½ã€‚ä¸è¿‡ï¼Œä¹è§‚é”ä¸»è¦é’ˆå¯¹çš„å¯¹è±¡æ˜¯å•ä¸ªå…±äº«å˜é‡ï¼ˆå‚è€ƒ`java.util.concurrent.atomic`åŒ…ä¸‹é¢çš„åŸå­å˜é‡ç±»ï¼‰ã€‚

### å¦‚ä½•å®ç°ä¹è§‚é”ï¼Ÿ

ä¹è§‚é”ä¸€èˆ¬ä¼šä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶æˆ– CAS ç®—æ³•å®ç°ï¼ŒCAS ç®—æ³•ç›¸å¯¹æ¥è¯´æ›´å¤šä¸€äº›ï¼Œè¿™é‡Œéœ€è¦æ ¼å¤–æ³¨æ„ã€‚


#### ç‰ˆæœ¬å·æœºåˆ¶

ä¸€èˆ¬æ˜¯åœ¨æ•°æ®è¡¨ä¸­åŠ ä¸Šä¸€ä¸ªæ•°æ®ç‰ˆæœ¬å· `version` å­—æ®µï¼Œè¡¨ç¤ºæ•°æ®è¢«ä¿®æ”¹çš„æ¬¡æ•°ã€‚å½“æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼Œ`version` å€¼ä¼šåŠ ä¸€ã€‚å½“çº¿ç¨‹ A è¦æ›´æ–°æ•°æ®å€¼æ—¶ï¼Œåœ¨è¯»å–æ•°æ®çš„åŒæ—¶ä¹Ÿä¼šè¯»å– `version` å€¼ï¼Œåœ¨æäº¤æ›´æ–°æ—¶ï¼Œè‹¥åˆšæ‰è¯»å–åˆ°çš„ version å€¼ä¸ºå½“å‰æ•°æ®åº“ä¸­çš„ `version` å€¼ç›¸ç­‰æ—¶æ‰æ›´æ–°ï¼Œå¦åˆ™é‡è¯•æ›´æ–°æ“ä½œï¼Œç›´åˆ°æ›´æ–°æˆåŠŸã€‚

**ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­**ï¼šå‡è®¾æ•°æ®åº“ä¸­å¸æˆ·ä¿¡æ¯è¡¨ä¸­æœ‰ä¸€ä¸ª version å­—æ®µï¼Œå½“å‰å€¼ä¸º 1 ï¼›è€Œå½“å‰å¸æˆ·ä½™é¢å­—æ®µï¼ˆ `balance` ï¼‰ä¸º $100 ã€‚

1. æ“ä½œå‘˜ A æ­¤æ—¶å°†å…¶è¯»å‡ºï¼ˆ `version`=1 ï¼‰ï¼Œå¹¶ä»å…¶å¸æˆ·ä½™é¢ä¸­æ‰£é™¤ $50ï¼ˆ $100-$50 ï¼‰ã€‚
2. åœ¨æ“ä½œå‘˜ A æ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œæ“ä½œå‘˜ B ä¹Ÿè¯»å…¥æ­¤ç”¨æˆ·ä¿¡æ¯ï¼ˆ `version`=1 ï¼‰ï¼Œå¹¶ä»å…¶å¸æˆ·ä½™é¢ä¸­æ‰£é™¤ $20 ï¼ˆ $100-$20 ï¼‰ã€‚
3. æ“ä½œå‘˜ A å®Œæˆäº†ä¿®æ”¹å·¥ä½œï¼Œå°†æ•°æ®ç‰ˆæœ¬å·ï¼ˆ `version`=1 ï¼‰ï¼Œè¿åŒå¸æˆ·æ‰£é™¤åä½™é¢ï¼ˆ `balance`=$50 ï¼‰ï¼Œæäº¤è‡³æ•°æ®åº“æ›´æ–°ï¼Œæ­¤æ—¶ç”±äºæäº¤æ•°æ®ç‰ˆæœ¬ç­‰äºæ•°æ®åº“è®°å½•å½“å‰ç‰ˆæœ¬ï¼Œæ•°æ®è¢«æ›´æ–°ï¼Œæ•°æ®åº“è®°å½• `version` æ›´æ–°ä¸º 2 ã€‚
4. æ“ä½œå‘˜ B å®Œæˆäº†æ“ä½œï¼Œä¹Ÿå°†ç‰ˆæœ¬å·ï¼ˆ `version`=1 ï¼‰è¯•å›¾å‘æ•°æ®åº“æäº¤æ•°æ®ï¼ˆ `balance`=$80 ï¼‰ï¼Œä½†æ­¤æ—¶æ¯”å¯¹æ•°æ®åº“è®°å½•ç‰ˆæœ¬æ—¶å‘ç°ï¼Œæ“ä½œå‘˜ B æäº¤çš„æ•°æ®ç‰ˆæœ¬å·ä¸º 1 ï¼Œæ•°æ®åº“è®°å½•å½“å‰ç‰ˆæœ¬ä¹Ÿä¸º 2 ï¼Œä¸æ»¡è¶³ â€œ æäº¤ç‰ˆæœ¬å¿…é¡»ç­‰äºå½“å‰ç‰ˆæœ¬æ‰èƒ½æ‰§è¡Œæ›´æ–° â€œ çš„ä¹è§‚é”ç­–ç•¥ï¼Œå› æ­¤ï¼Œæ“ä½œå‘˜ B çš„æäº¤è¢«é©³å›ã€‚

è¿™æ ·å°±é¿å…äº†æ“ä½œå‘˜ B ç”¨åŸºäº `version`=1 çš„æ—§æ•°æ®ä¿®æ”¹çš„ç»“æœè¦†ç›–æ“ä½œå‘˜ A çš„æ“ä½œç»“æœçš„å¯èƒ½ã€‚

#### `CAS`ç®—æ³•

CAS çš„å…¨ç§°æ˜¯ **Compare And Swapï¼ˆæ¯”è¾ƒä¸äº¤æ¢ï¼‰** ï¼Œç”¨äºå®ç°ä¹è§‚é”ï¼Œè¢«å¹¿æ³›åº”ç”¨äºå„å¤§æ¡†æ¶ä¸­ã€‚CAS çš„æ€æƒ³å¾ˆç®€å•ï¼Œå°±æ˜¯ç”¨ä¸€ä¸ªé¢„æœŸå€¼å’Œè¦æ›´æ–°çš„å˜é‡å€¼è¿›è¡Œæ¯”è¾ƒï¼Œä¸¤å€¼ç›¸ç­‰æ‰ä¼šè¿›è¡Œæ›´æ–°ã€‚

CAS æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œåº•å±‚ä¾èµ–äºä¸€æ¡ CPU çš„åŸå­æŒ‡ä»¤ã€‚

> **åŸå­æ“ä½œ** å³æœ€å°ä¸å¯æ‹†åˆ†çš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´æ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸èƒ½è¢«æ‰“æ–­ï¼Œç›´åˆ°æ“ä½œå®Œæˆã€‚

CAS æ¶‰åŠåˆ°ä¸‰ä¸ªæ“ä½œæ•°ï¼š

- **V**ï¼šè¦æ›´æ–°çš„å˜é‡å€¼(Var)
- **E**ï¼šé¢„æœŸå€¼(Expected)
- **N**ï¼šæ‹Ÿå†™å…¥çš„æ–°å€¼(New)

å½“ä¸”ä»…å½“ V çš„å€¼ç­‰äº E æ—¶ï¼ŒCAS é€šè¿‡åŸå­æ–¹å¼ç”¨æ–°å€¼ N æ¥æ›´æ–° V çš„å€¼ã€‚å¦‚æœä¸ç­‰ï¼Œè¯´æ˜å·²ç»æœ‰å…¶å®ƒçº¿ç¨‹æ›´æ–°äº† Vï¼Œåˆ™å½“å‰çº¿ç¨‹æ”¾å¼ƒæ›´æ–°ã€‚

**ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­**ï¼šçº¿ç¨‹ A è¦ä¿®æ”¹å˜é‡ i çš„å€¼ä¸º 6ï¼Œi åŸå€¼ä¸º 1ï¼ˆV = 1ï¼ŒE=1ï¼ŒN=6ï¼Œå‡è®¾ä¸å­˜åœ¨ ABA é—®é¢˜ï¼‰ã€‚

1. i ä¸ 1 è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œ åˆ™è¯´æ˜æ²¡è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œå¯ä»¥è¢«è®¾ç½®ä¸º 6 ã€‚
2. i ä¸ 1 è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™è¯´æ˜è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œå½“å‰çº¿ç¨‹æ”¾å¼ƒæ›´æ–°ï¼ŒCAS æ“ä½œå¤±è´¥ã€‚

å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨ CAS æ“ä½œä¸€ä¸ªå˜é‡æ—¶ï¼Œåªæœ‰ä¸€ä¸ªä¼šèƒœå‡ºï¼Œå¹¶æˆåŠŸæ›´æ–°ï¼Œå…¶ä½™å‡ä¼šå¤±è´¥ï¼Œä½†å¤±è´¥çš„çº¿ç¨‹å¹¶ä¸ä¼šè¢«æŒ‚èµ·ï¼Œä»…æ˜¯è¢«å‘ŠçŸ¥å¤±è´¥ï¼Œå¹¶ä¸”å…è®¸å†æ¬¡å°è¯•ï¼Œå½“ç„¶ä¹Ÿå…è®¸å¤±è´¥çš„çº¿ç¨‹æ”¾å¼ƒæ“ä½œã€‚

Java è¯­è¨€å¹¶æ²¡æœ‰ç›´æ¥å®ç° CASï¼ŒCAS ç›¸å…³çš„å®ç°æ˜¯é€šè¿‡ C++ å†…è”æ±‡ç¼–çš„å½¢å¼å®ç°çš„ï¼ˆJNI è°ƒç”¨ï¼‰ã€‚å› æ­¤ï¼Œ CAS çš„å…·ä½“å®ç°å’Œæ“ä½œç³»ç»Ÿä»¥åŠ CPU éƒ½æœ‰å…³ç³»ã€‚

`sun.misc`åŒ…ä¸‹çš„`Unsafe`ç±»æä¾›äº†`compareAndSwapObject`ã€`compareAndSwapInt`ã€`compareAndSwapLong`æ–¹æ³•æ¥å®ç°çš„å¯¹`Object`ã€`int`ã€`long`ç±»å‹çš„ CAS æ“ä½œ

```java
/**
  *  CAS
  * @param o         åŒ…å«è¦ä¿®æ”¹fieldçš„å¯¹è±¡
  * @param offset    å¯¹è±¡ä¸­æŸfieldçš„åç§»é‡
  * @param expected  æœŸæœ›å€¼
  * @param update    æ›´æ–°å€¼
  * @return          true | false
  */
public final native boolean compareAndSwapObject(Object o, long offset,  Object expected, Object update);

public final native boolean compareAndSwapInt(Object o, long offset, int expected,int update);

public final native boolean compareAndSwapLong(Object o, long offset, long expected, long update);
```

## `synchronized`å…³é”®å­—

### `synchronized`æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`synchronized` æ˜¯ Java ä¸­çš„ä¸€ä¸ªå…³é”®å­—ï¼Œç¿»è¯‘æˆä¸­æ–‡æ˜¯åŒæ­¥çš„æ„æ€ï¼Œä¸»è¦è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ï¼Œå¯ä»¥ä¿è¯è¢«å®ƒä¿®é¥°çš„æ–¹æ³•æˆ–è€…ä»£ç å—åœ¨ä»»æ„æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚

åœ¨ Java æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œ`synchronized` å±äº **é‡é‡çº§é”**ï¼Œæ•ˆç‡ä½ä¸‹ã€‚è¿™æ˜¯å› ä¸ºç›‘è§†å™¨é”ï¼ˆmonitorï¼‰æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„ `Mutex Lock` æ¥å®ç°çš„ï¼ŒJava çš„çº¿ç¨‹æ˜¯æ˜ å°„åˆ°æ“ä½œç³»ç»Ÿçš„åŸç”Ÿçº¿ç¨‹ä¹‹ä¸Šçš„ã€‚å¦‚æœè¦æŒ‚èµ·æˆ–è€…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½éœ€è¦æ“ä½œç³»ç»Ÿå¸®å¿™å®Œæˆï¼Œè€Œæ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ã€‚

ä¸è¿‡ï¼Œåœ¨ Java 6 ä¹‹åï¼Œ `synchronized` å¼•å…¥äº†å¤§é‡çš„ä¼˜åŒ–å¦‚è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”ã€é”æ¶ˆé™¤ã€é”ç²—åŒ–ã€åå‘é”ã€è½»é‡çº§é”ç­‰æŠ€æœ¯æ¥å‡å°‘é”æ“ä½œçš„å¼€é”€ï¼Œè¿™äº›ä¼˜åŒ–è®© `synchronized` é”çš„æ•ˆç‡æå‡äº†å¾ˆå¤šã€‚å› æ­¤ï¼Œ `synchronized` è¿˜æ˜¯å¯ä»¥åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨çš„ï¼Œåƒ JDK æºç ã€å¾ˆå¤šå¼€æºæ¡†æ¶éƒ½å¤§é‡ä½¿ç”¨äº† `synchronized` ã€‚

å…³äºåå‘é”å¤šè¡¥å……ä¸€ç‚¹ï¼šç”±äºåå‘é”å¢åŠ äº† JVM çš„å¤æ‚æ€§ï¼ŒåŒæ—¶ä¹Ÿå¹¶æ²¡æœ‰ä¸ºæ‰€æœ‰åº”ç”¨éƒ½å¸¦æ¥æ€§èƒ½æå‡ã€‚å› æ­¤ï¼Œåœ¨ JDK15 ä¸­ï¼Œåå‘é”è¢«é»˜è®¤å…³é—­ï¼ˆä»ç„¶å¯ä»¥ä½¿ç”¨ `-XX:+UseBiasedLocking` å¯ç”¨åå‘é”ï¼‰ï¼Œåœ¨ JDK18 ä¸­ï¼Œåå‘é”å·²ç»è¢«å½»åº•åºŸå¼ƒï¼ˆæ— æ³•é€šè¿‡å‘½ä»¤è¡Œæ‰“å¼€ï¼‰ã€‚

### å¦‚ä½•ä½¿ç”¨`synchronized`ï¼Ÿ

`synchronized`Â å…³é”®å­—çš„ä½¿ç”¨æ–¹å¼ä¸»è¦æœ‰ä¸‹é¢ 3 ç§ï¼š

1. ä¿®é¥°å®ä¾‹æ–¹æ³•
2. ä¿®é¥°é™æ€æ–¹æ³•
3. ä¿®é¥°ä»£ç å—

**1ã€ä¿®é¥°å®ä¾‹æ–¹æ³•**Â ï¼ˆé”å½“å‰å¯¹è±¡å®ä¾‹ï¼‰

ç»™å½“å‰å¯¹è±¡å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—Â **å½“å‰å¯¹è±¡å®ä¾‹çš„é”**Â ã€‚

```java
synchronized void method() {
    //ä¸šåŠ¡ä»£ç 
}
```

**2ã€ä¿®é¥°é™æ€æ–¹æ³•** ï¼ˆé”å½“å‰ç±»ï¼‰

ç»™å½“å‰ç±»åŠ é”ï¼Œä¼šä½œç”¨äºç±»çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹ ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— **å½“å‰ class çš„é”**ã€‚

è¿™æ˜¯å› ä¸ºé™æ€æˆå‘˜ä¸å±äºä»»ä½•ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå½’æ•´ä¸ªç±»æ‰€æœ‰ï¼Œä¸ä¾èµ–äºç±»çš„ç‰¹å®šå®ä¾‹ï¼Œè¢«ç±»çš„æ‰€æœ‰å®ä¾‹å…±äº«ã€‚

```java
synchronized static void method() {
    //ä¸šåŠ¡ä»£ç 
}
```

é™æ€ `synchronized` æ–¹æ³•å’Œéé™æ€ `synchronized` æ–¹æ³•ä¹‹é—´çš„è°ƒç”¨äº’æ–¥ä¹ˆï¼Ÿä¸äº’æ–¥ï¼å¦‚æœä¸€ä¸ªçº¿ç¨‹ A è°ƒç”¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€ `synchronized` æ–¹æ³•ï¼Œè€Œçº¿ç¨‹ B éœ€è¦è°ƒç”¨è¿™ä¸ªå®ä¾‹å¯¹è±¡æ‰€å±ç±»çš„é™æ€ `synchronized` æ–¹æ³•ï¼Œæ˜¯å…è®¸çš„ï¼Œä¸ä¼šå‘ç”Ÿäº’æ–¥ç°è±¡ï¼Œå› ä¸ºè®¿é—®é™æ€ `synchronized` æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰ç±»çš„é”ï¼Œè€Œè®¿é—®éé™æ€ `synchronized` æ–¹æ³•å ç”¨çš„é”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡é”ã€‚

**3ã€ä¿®é¥°ä»£ç å—** ï¼ˆé”æŒ‡å®šå¯¹è±¡/ç±»ï¼‰

å¯¹æ‹¬å·é‡ŒæŒ‡å®šçš„å¯¹è±¡/ç±»åŠ é”ï¼š

- `synchronized(object)` è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç åº“å‰è¦è·å¾— **ç»™å®šå¯¹è±¡çš„é”**ã€‚
- `synchronized(ç±».class)` è¡¨ç¤ºè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾— **ç»™å®š Class çš„é”**

```java
synchronized(this) {
    //ä¸šåŠ¡ä»£ç 
}
```

**æ€»ç»“ï¼š**

- `synchronized` å…³é”®å­—åŠ åˆ° `static` é™æ€æ–¹æ³•å’Œ `synchronized(class)` ä»£ç å—ä¸Šéƒ½æ˜¯æ˜¯ç»™ Class ç±»ä¸Šé”ï¼›
- `synchronized` å…³é”®å­—åŠ åˆ°å®ä¾‹æ–¹æ³•ä¸Šæ˜¯ç»™å¯¹è±¡å®ä¾‹ä¸Šé”ï¼›
- å°½é‡ä¸è¦ä½¿ç”¨ `synchronized(String a)` å› ä¸º JVM ä¸­ï¼Œå­—ç¬¦ä¸²å¸¸é‡æ± å…·æœ‰ç¼“å­˜åŠŸèƒ½ã€‚

### æ„é€ æ–¹æ³•å¯ä»¥ç”¨`synchronized`ä¿®é¥°ä¹ˆï¼Ÿ

æ„é€ æ–¹æ³•ä¸èƒ½ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°ã€‚ä¸è¿‡ï¼Œå¯ä»¥åœ¨æ„é€ æ–¹æ³•å†…éƒ¨ä½¿ç”¨ synchronized ä»£ç å—ã€‚

å¦å¤–ï¼Œ**æ„é€ æ–¹æ³•æœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„**ï¼Œä½†å¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­æ¶‰åŠåˆ°å…±äº«èµ„æºçš„æ“ä½œï¼Œå°±éœ€è¦é‡‡å–é€‚å½“çš„åŒæ­¥æªæ–½æ¥ä¿è¯æ•´ä¸ªæ„é€ è¿‡ç¨‹çš„çº¿ç¨‹å®‰å…¨ã€‚

### ğŸŒŸ`synchronized`åº•å±‚åŸç†

synchronized å…³é”®å­—åº•å±‚åŸç†å±äº JVM å±‚é¢çš„ä¸œè¥¿ã€‚

#### `synchronized`åŒæ­¥è¯­å¥å—çš„æƒ…å†µ

```java
package com.stone;  
  
public class SynchronizedDemo {  
    public void method() {  
        synchronized (this) {  
            System.out.println("synchronized code");  
        }  
    }  
}
```

é€šè¿‡ JDK è‡ªå¸¦çš„ `javap` å‘½ä»¤æŸ¥çœ‹ `SynchronizedDemo` ç±»çš„ç›¸å…³å­—èŠ‚ç ä¿¡æ¯ï¼šé¦–å…ˆåˆ‡æ¢åˆ°ç±»çš„å¯¹åº”ç›®å½•æ‰§è¡Œ `javac SynchronizedDemo.java` å‘½ä»¤ç”Ÿæˆç¼–è¯‘åçš„ .class æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œ`javap -c -s -v -l SynchronizedDemo.class`ã€‚

![SynchronizedDemo-class](../images/SynchronizedDemo-class.png)

ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š**`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚**

ä¸Šé¢çš„å­—èŠ‚ç ä¸­åŒ…å«ä¸€ä¸ª `monitorenter` æŒ‡ä»¤ä»¥åŠä¸¤ä¸ª `monitorexit` æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸ºäº†ä¿è¯é”åœ¨åŒæ­¥ä»£ç å—ä»£ç æ­£å¸¸æ‰§è¡Œä»¥åŠå‡ºç°å¼‚å¸¸çš„è¿™ä¸¤ç§æƒ…å†µä¸‹éƒ½èƒ½è¢«æ­£ç¡®é‡Šæ”¾ã€‚

å½“æ‰§è¡Œ `monitorenter` æŒ‡ä»¤æ—¶ï¼Œçº¿ç¨‹è¯•å›¾è·å–é”ä¹Ÿå°±æ˜¯è·å– **å¯¹è±¡ç›‘è§†å™¨ `monitor`** çš„æŒæœ‰æƒã€‚

> åœ¨ Java è™šæ‹Ÿæœº(HotSpot)ä¸­ï¼ŒMonitor æ˜¯åŸºäº C++å®ç°çš„ï¼Œç”±[ObjectMonitor](https://github.com/openjdk-mirror/jdk7u-hotspot/blob/50bdefc3afe944ca74c3093e7448d6b889cd20d1/src/share/vm/runtime/objectMonitor.cpp)å®ç°çš„ã€‚æ¯ä¸ªå¯¹è±¡ä¸­éƒ½å†…ç½®äº†ä¸€ä¸ª `ObjectMonitor`å¯¹è±¡ã€‚
> 
> å¦å¤–ï¼Œ`wait/notify`ç­‰æ–¹æ³•ä¹Ÿä¾èµ–äº`monitor`å¯¹è±¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰åœ¨åŒæ­¥çš„å—æˆ–è€…æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨`wait/notify`ç­‰æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡º`java.lang.IllegalMonitorStateException`çš„å¼‚å¸¸çš„åŸå› ã€‚

åœ¨æ‰§è¡Œ`monitorenter`æ—¶ï¼Œä¼šå°è¯•è·å–å¯¹è±¡çš„é”ï¼Œå¦‚æœé”çš„è®¡æ•°å™¨ä¸º 0 åˆ™è¡¨ç¤ºé”å¯ä»¥è¢«è·å–ï¼Œè·å–åå°†é”è®¡æ•°å™¨è®¾ä¸º 1 ä¹Ÿå°±æ˜¯åŠ  1ã€‚

![synchronized-get-lock-code-block](../images/synchronized-get-lock-code-block.png)

å¯¹è±¡é”çš„çš„æ‹¥æœ‰è€…çº¿ç¨‹æ‰å¯ä»¥æ‰§è¡ŒÂ `monitorexit`Â æŒ‡ä»¤æ¥é‡Šæ”¾é”ã€‚åœ¨æ‰§è¡ŒÂ `monitorexit`Â æŒ‡ä»¤åï¼Œå°†é”è®¡æ•°å™¨è®¾ä¸º 0ï¼Œè¡¨æ˜é”è¢«é‡Šæ”¾ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥å°è¯•è·å–é”ã€‚

![synchronized-release-lock-block](../images/synchronized-release-lock-block.png)

å¦‚æœè·å–å¯¹è±¡é”å¤±è´¥ï¼Œé‚£å½“å‰çº¿ç¨‹å°±è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°é”è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾ä¸ºæ­¢ã€‚

#### `synchronized`ä¿®é¥°æ–¹æ³•çš„æƒ…å†µ

```java
public class SynchronizedDemo2 {
    public synchronized void method() {
        System.out.println("synchronized æ–¹æ³•");
    }
}
```

![synchronizedå…³é”®å­—åŸç†2](../images/synchronizedå…³é”®å­—åŸç†2.png)

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚JVM é€šè¿‡è¯¥ `ACC_SYNCHRONIZED` è®¿é—®æ ‡å¿—æ¥è¾¨åˆ«ä¸€ä¸ªæ–¹æ³•æ˜¯å¦å£°æ˜ä¸ºåŒæ­¥æ–¹æ³•ï¼Œä»è€Œæ‰§è¡Œç›¸åº”çš„åŒæ­¥è°ƒç”¨ã€‚

å¦‚æœæ˜¯å®ä¾‹æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å®ä¾‹å¯¹è±¡çš„é”ã€‚å¦‚æœæ˜¯é™æ€æ–¹æ³•ï¼ŒJVM ä¼šå°è¯•è·å–å½“å‰ class çš„é”ã€‚

#### æ€»ç»“

`synchronized` åŒæ­¥è¯­å¥å—çš„å®ç°ä½¿ç”¨çš„æ˜¯ `monitorenter` å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå…¶ä¸­ `monitorenter` æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ`monitorexit` æŒ‡ä»¤åˆ™æŒ‡æ˜åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚

`synchronized` ä¿®é¥°çš„æ–¹æ³•å¹¶æ²¡æœ‰ `monitorenter` æŒ‡ä»¤å’Œ `monitorexit` æŒ‡ä»¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ `ACC_SYNCHRONIZED` æ ‡è¯†ï¼Œè¯¥æ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚

**ä¸è¿‡ï¼Œä¸¤è€…çš„æœ¬è´¨éƒ½æ˜¯å¯¹å¯¹è±¡ç›‘è§†å™¨ monitor çš„è·å–ã€‚**

### `synchronized`å’Œ`volatile`æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

`synchronized` å…³é”®å­—å’Œ `volatile` å…³é”®å­—æ˜¯ä¸¤ä¸ªäº’è¡¥çš„å­˜åœ¨ï¼Œè€Œä¸æ˜¯å¯¹ç«‹çš„å­˜åœ¨ï¼

- `volatile` å…³é”®å­—æ˜¯çº¿ç¨‹åŒæ­¥çš„è½»é‡çº§å®ç°ï¼Œæ‰€ä»¥ `volatile`æ€§èƒ½è‚¯å®šæ¯”`synchronized`å…³é”®å­—è¦å¥½ ã€‚ä½†æ˜¯ `volatile` å…³é”®å­—åªèƒ½ç”¨äºå˜é‡è€Œ `synchronized` å…³é”®å­—å¯ä»¥ä¿®é¥°æ–¹æ³•ä»¥åŠä»£ç å— ã€‚
- `volatile` å…³é”®å­—èƒ½ä¿è¯æ•°æ®çš„å¯è§æ€§ï¼Œä½†ä¸èƒ½ä¿è¯æ•°æ®çš„åŸå­æ€§ã€‚`synchronized` å…³é”®å­—ä¸¤è€…éƒ½èƒ½ä¿è¯ã€‚
- `volatile`å…³é”®å­—ä¸»è¦ç”¨äºè§£å†³å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œè€Œ `synchronized` å…³é”®å­—è§£å†³çš„æ˜¯å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥æ€§ã€‚

|    ç‰¹æ€§    | `synchronized` |  `volatile`  |
| :------: | :------------: | :----------: |
| **ä½œç”¨èŒƒå›´** |     æ–¹æ³•æˆ–ä»£ç å—     |      å˜é‡      |
| **é”æœºåˆ¶**  |    åŸºäºå¯¹è±¡é”æˆ–ç±»é”    |     æ— é”æœºåˆ¶     |
| **å¯è§æ€§**  |     ä¿è¯å¯è§æ€§      |    ä¿è¯å¯è§æ€§     |
| **åŸå­æ€§**  |     ä¿è¯åŸå­æ€§      |    ä¸ä¿è¯åŸå­æ€§    |
| **æœ‰åºæ€§**  |     ä¿è¯æœ‰åºæ€§      |    ä¿è¯æœ‰åºæ€§     |
|  **æ€§èƒ½**  |   è¾ƒä½ï¼ˆå› ä¸ºé”çš„å¼€é”€ï¼‰   |      è¾ƒé«˜      |
| **é€‚ç”¨åœºæ™¯** |  éœ€è¦äº’æ–¥è®¿é—®çš„å¤æ‚æ“ä½œ   | å•ä¸€å˜é‡çš„å¯è§æ€§å’Œæœ‰åºæ€§ |

## `ReentrantLock`

### `ReentrantLock`æ˜¯ä»€ä¹ˆï¼Ÿ

`ReentrantLock` å®ç°äº† `Lock` æ¥å£ï¼Œæ˜¯ä¸€ä¸ªå¯é‡å…¥ä¸”ç‹¬å å¼çš„é”ï¼Œå’Œ `synchronized` å…³é”®å­—ç±»ä¼¼ã€‚ä¸è¿‡ï¼Œ`ReentrantLock` æ›´çµæ´»ã€æ›´å¼ºå¤§ï¼Œå¢åŠ äº†è½®è¯¢ã€è¶…æ—¶ã€ä¸­æ–­ã€å…¬å¹³é”å’Œéå…¬å¹³é”ç­‰é«˜çº§åŠŸèƒ½ã€‚

```java
public class ReentrantLock implements Lock, java.io.Serializable {}
```

`ReentrantLock` é‡Œé¢æœ‰ä¸€ä¸ªå†…éƒ¨ç±» `Sync`ï¼Œ`Sync` ç»§æ‰¿ AQSï¼ˆ`AbstractQueuedSynchronizer`ï¼‰ï¼Œæ·»åŠ é”å’Œé‡Šæ”¾é”çš„å¤§éƒ¨åˆ†æ“ä½œå®é™…ä¸Šéƒ½æ˜¯åœ¨ `Sync` ä¸­å®ç°çš„ã€‚`Sync` æœ‰å…¬å¹³é” `FairSync` å’Œéå…¬å¹³é” `NonfairSync` ä¸¤ä¸ªå­ç±»ã€‚

![reentrantlock-class-diagram](../images/reentrantlock-class-diagram.png)

`ReentrantLock` é»˜è®¤ä½¿ç”¨éå…¬å¹³é”ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ„é€ å™¨æ¥æ˜¾å¼çš„æŒ‡å®šä½¿ç”¨å…¬å¹³é”ã€‚

```java
// ä¼ å…¥ä¸€ä¸ª boolean å€¼ï¼Œtrue æ—¶ä¸ºå…¬å¹³é”ï¼Œfalse æ—¶ä¸ºéå…¬å¹³é”
public ReentrantLock(boolean fair) {
    sync = fair ? new FairSync() : new NonfairSync();
}
```

### å…¬å¹³é”å’Œéå…¬å¹³é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- **å…¬å¹³é”** : é”è¢«é‡Šæ”¾ä¹‹åï¼Œå…ˆç”³è¯·çš„çº¿ç¨‹å…ˆå¾—åˆ°é”ã€‚æ€§èƒ½è¾ƒå·®ä¸€äº›ï¼Œå› ä¸ºå…¬å¹³é”ä¸ºäº†ä¿è¯æ—¶é—´ä¸Šçš„ç»å¯¹é¡ºåºï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢æ›´é¢‘ç¹ã€‚
- **éå…¬å¹³é”**ï¼šé”è¢«é‡Šæ”¾ä¹‹åï¼Œåç”³è¯·çš„çº¿ç¨‹å¯èƒ½ä¼šå…ˆè·å–åˆ°é”ï¼Œæ˜¯éšæœºæˆ–è€…æŒ‰ç…§å…¶ä»–ä¼˜å…ˆçº§æ’åºçš„ã€‚æ€§èƒ½æ›´å¥½ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´æŸäº›çº¿ç¨‹æ°¸è¿œæ— æ³•è·å–åˆ°é”ã€‚

### ğŸŒŸ`synchronized`å’Œ`ReentrantLock`æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

#### ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”

**å¯é‡å…¥é”** ä¹Ÿå«é€’å½’é”ï¼ŒæŒ‡çš„æ˜¯çº¿ç¨‹å¯ä»¥å†æ¬¡è·å–è‡ªå·±çš„å†…éƒ¨é”ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹è·å¾—äº†æŸä¸ªå¯¹è±¡çš„é”ï¼Œæ­¤æ—¶è¿™ä¸ªå¯¹è±¡é”è¿˜æ²¡æœ‰é‡Šæ”¾ï¼Œå½“å…¶å†æ¬¡æƒ³è¦è·å–è¿™ä¸ªå¯¹è±¡çš„é”çš„æ—¶å€™è¿˜æ˜¯å¯ä»¥è·å–çš„ï¼Œå¦‚æœæ˜¯ä¸å¯é‡å…¥é”çš„è¯ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚

JDK æä¾›çš„æ‰€æœ‰ç°æˆçš„ `Lock` å®ç°ç±»ï¼ŒåŒ…æ‹¬ `synchronized` å…³é”®å­—é”éƒ½æ˜¯å¯é‡å…¥çš„ã€‚

åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œ`method1()` å’Œ `method2()`éƒ½è¢« `synchronized` å…³é”®å­—ä¿®é¥°ï¼Œ`method1()`è°ƒç”¨äº†`method2()`ã€‚

```java
public class SynchronizedDemo {
    public synchronized void method1() {
        System.out.println("æ–¹æ³•1");
        method2();
    }

    public synchronized void method2() {
        System.out.println("æ–¹æ³•2");
    }
}
```

ç”±äº `synchronized`é”æ˜¯å¯é‡å…¥çš„ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹åœ¨è°ƒç”¨`method1()` æ—¶å¯ä»¥ç›´æ¥è·å¾—å½“å‰å¯¹è±¡çš„é”ï¼Œæ‰§è¡Œ `method2()` çš„æ—¶å€™å¯ä»¥å†æ¬¡è·å–è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œä¸ä¼šäº§ç”Ÿæ­»é”é—®é¢˜ã€‚å‡å¦‚`synchronized`æ˜¯ä¸å¯é‡å…¥é”çš„è¯ï¼Œç”±äºè¯¥å¯¹è±¡çš„é”å·²è¢«å½“å‰çº¿ç¨‹æ‰€æŒæœ‰ä¸”æ— æ³•é‡Šæ”¾ï¼Œè¿™å°±å¯¼è‡´çº¿ç¨‹åœ¨æ‰§è¡Œ `method2()`æ—¶è·å–é”å¤±è´¥ï¼Œä¼šå‡ºç°æ­»é”é—®é¢˜ã€‚

#### `ReentrantLock`æ¯”`synchronized`å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½

ç›¸æ¯”`synchronized`ï¼Œ`ReentrantLock`å¢åŠ äº†ä¸€äº›é«˜çº§åŠŸèƒ½ã€‚ä¸»è¦æ¥è¯´ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š

- **ç­‰å¾…å¯ä¸­æ–­** : `ReentrantLock`æä¾›äº†ä¸€ç§èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹çš„æœºåˆ¶ï¼Œé€šè¿‡ `lock.lockInterruptibly()` æ¥å®ç°è¿™ä¸ªæœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…è·å–é”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ã€Œ `interrupt()` ã€ï¼Œå½“å‰çº¿ç¨‹å°±ä¼šæŠ›å‡º `InterruptedException` å¼‚å¸¸ï¼Œå¯ä»¥æ•æ‰è¯¥å¼‚å¸¸è¿›è¡Œç›¸åº”å¤„ç†ã€‚
- **å¯å®ç°å…¬å¹³é”** : `ReentrantLock`å¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚è€Œ`synchronized`åªèƒ½æ˜¯éå…¬å¹³é”ã€‚æ‰€è°“çš„å…¬å¹³é”å°±æ˜¯å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚`ReentrantLock`é»˜è®¤æƒ…å†µæ˜¯éå…¬å¹³çš„ï¼Œå¯ä»¥é€šè¿‡ `ReentrantLock`ç±»çš„`ReentrantLock(boolean fair)`æ„é€ æ–¹æ³•æ¥æŒ‡å®šæ˜¯å¦æ˜¯å…¬å¹³çš„ã€‚
- **å¯å®ç°é€‰æ‹©æ€§é€šçŸ¥ï¼ˆé”å¯ä»¥ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼‰**: `synchronized`å…³é”®å­—ä¸`wait()`å’Œ`notify()`/`notifyAll()`æ–¹æ³•ç›¸ç»“åˆå¯ä»¥å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚`ReentrantLock`ç±»å½“ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ˜¯éœ€è¦å€ŸåŠ©äº`Condition`æ¥å£ä¸`newCondition()`æ–¹æ³•ã€‚
- **æ”¯æŒè¶…æ—¶** ï¼š`ReentrantLock` æä¾›äº† `tryLock(timeout)` çš„æ–¹æ³•ï¼Œå¯ä»¥æŒ‡å®šç­‰å¾…è·å–é”çš„æœ€é•¿ç­‰å¾…æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡äº†ç­‰å¾…æ—¶é—´ï¼Œå°±ä¼šè·å–é”å¤±è´¥ï¼Œä¸ä¼šä¸€ç›´ç­‰å¾…ã€‚

å¦‚æœä½ æƒ³ä½¿ç”¨ä¸Šè¿°åŠŸèƒ½ï¼Œé‚£ä¹ˆé€‰æ‹© `ReentrantLock` æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

å…³äº `Condition`æ¥å£çš„è¡¥å……ï¼š

> `Condition`æ˜¯ JDK1.5 ä¹‹åæ‰æœ‰çš„ï¼Œå®ƒå…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§ï¼Œæ¯”å¦‚å¯ä»¥å®ç°å¤šè·¯é€šçŸ¥åŠŸèƒ½ä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ª`Lock`å¯¹è±¡ä¸­å¯ä»¥åˆ›å»ºå¤šä¸ª`Condition`å®ä¾‹ï¼ˆå³å¯¹è±¡ç›‘è§†å™¨ï¼‰ï¼Œ**çº¿ç¨‹å¯¹è±¡å¯ä»¥æ³¨å†Œåœ¨æŒ‡å®šçš„`Condition`ä¸­ï¼Œä»è€Œå¯ä»¥æœ‰é€‰æ‹©æ€§çš„è¿›è¡Œçº¿ç¨‹é€šçŸ¥ï¼Œåœ¨è°ƒåº¦çº¿ç¨‹ä¸Šæ›´åŠ çµæ´»ã€‚ åœ¨ä½¿ç”¨`notify()/notifyAll()`æ–¹æ³•è¿›è¡Œé€šçŸ¥æ—¶ï¼Œè¢«é€šçŸ¥çš„çº¿ç¨‹æ˜¯ç”± JVM é€‰æ‹©çš„ï¼Œç”¨`ReentrantLock`ç±»ç»“åˆ`Condition`å®ä¾‹å¯ä»¥å®ç°â€œé€‰æ‹©æ€§é€šçŸ¥â€** ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸é‡è¦ï¼Œè€Œä¸”æ˜¯ `Condition` æ¥å£é»˜è®¤æä¾›çš„ã€‚è€Œ`synchronized`å…³é”®å­—å°±ç›¸å½“äºæ•´ä¸ª `Lock` å¯¹è±¡ä¸­åªæœ‰ä¸€ä¸ª`Condition`å®ä¾‹ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ³¨å†Œåœ¨å®ƒä¸€ä¸ªèº«ä¸Šã€‚å¦‚æœæ‰§è¡Œ`notifyAll()`æ–¹æ³•çš„è¯å°±ä¼šé€šçŸ¥æ‰€æœ‰å¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ï¼Œè¿™æ ·ä¼šé€ æˆå¾ˆå¤§çš„æ•ˆç‡é—®é¢˜ã€‚è€Œ`Condition`å®ä¾‹çš„`signalAll()`æ–¹æ³•ï¼Œåªä¼šå”¤é†’æ³¨å†Œåœ¨è¯¥`Condition`å®ä¾‹ä¸­çš„æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚

å…³äº **ç­‰å¾…å¯ä¸­æ–­** çš„è¡¥å……ï¼š

> `lockInterruptibly()` ä¼šè®©è·å–é”çš„çº¿ç¨‹åœ¨é˜»å¡ç­‰å¾…çš„è¿‡ç¨‹ä¸­å¯ä»¥å“åº”ä¸­æ–­ï¼Œå³å½“å‰çº¿ç¨‹åœ¨è·å–é”çš„æ—¶å€™ï¼Œå‘ç°é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œå°±ä¼šé˜»å¡ç­‰å¾…ã€‚
>åœ¨é˜»å¡ç­‰å¾…çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹ä¸­æ–­å½“å‰çº¿ç¨‹ `interrupt()` ï¼Œå°±ä¼šæŠ›å‡º `InterruptedException` å¼‚å¸¸ï¼Œå¯ä»¥æ•è·è¯¥å¼‚å¸¸ï¼Œåšä¸€äº›å¤„ç†æ“ä½œã€‚
ä¸ºäº†æ›´å¥½ç†è§£è¿™ä¸ªæ–¹æ³•ï¼Œå€Ÿç”¨ Stack Overflow ä¸Šçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼Œå¯ä»¥æ›´å¥½åœ°ç†è§£ `lockInterruptibly()` å¯ä»¥å“åº”ä¸­æ–­ï¼š
```java
public class MyRentrantlock {
    Thread t = new Thread() {
        @Override
        public void run() {
            ReentrantLock r = new ReentrantLock();
            // 1.1ã€ç¬¬ä¸€æ¬¡å°è¯•è·å–é”ï¼Œå¯ä»¥è·å–æˆåŠŸ
            r.lock();

            // 1.2ã€æ­¤æ—¶é”çš„é‡å…¥æ¬¡æ•°ä¸º 1
            System.out.println("lock() : lock count :" + r.getHoldCount());

            // 2ã€ä¸­æ–­å½“å‰çº¿ç¨‹ï¼Œé€šè¿‡ Thread.currentThread().isInterrupted() å¯ä»¥çœ‹åˆ°å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä¸º true
            interrupt();
            System.out.println("Current thread is intrupted");

            // 3.1ã€å°è¯•è·å–é”ï¼Œå¯ä»¥æˆåŠŸè·å–
            r.tryLock();
            // 3.2ã€æ­¤æ—¶é”çš„é‡å…¥æ¬¡æ•°ä¸º 2
            System.out.println("tryLock() on intrupted thread lock count :" + r.getHoldCount());
            try {
                // 4ã€æ‰“å°çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä¸º trueï¼Œé‚£ä¹ˆè°ƒç”¨ lockInterruptibly() æ–¹æ³•å°±ä¼šæŠ›å‡º InterruptedException å¼‚å¸¸
                System.out.println("Current Thread isInterrupted:" + Thread.currentThread().isInterrupted());
                r.lockInterruptibly();
                System.out.println("lockInterruptibly() --NOt executable statement" + r.getHoldCount());
            } catch (InterruptedException e) {
                r.lock();
                System.out.println("Error");
            } finally {
                r.unlock();
            }

            // 5ã€æ‰“å°é”çš„é‡å…¥æ¬¡æ•°ï¼Œå¯ä»¥å‘ç° lockInterruptibly() æ–¹æ³•å¹¶æ²¡æœ‰æˆåŠŸè·å–åˆ°é”
            System.out.println("lockInterruptibly() not able to Acqurie lock: lock count :" + r.getHoldCount());

            r.unlock();
            System.out.println("lock count :" + r.getHoldCount());
            r.unlock();
            System.out.println("lock count :" + r.getHoldCount());
        }
    };
    public static void main(String str[]) {
        MyRentrantlock m = new MyRentrantlock();
        m.t.start();
    }
}
```
è¾“å‡ºï¼š
```bash
lock() : lock count :1
Current thread is intrupted
tryLock() on intrupted thread lock count :2
Current Thread isInterrupted:true
Error
lockInterruptibly() not able to Acqurie lock: lock count :2
lock count :1
lock count :0
```

å…³äºÂ **æ”¯æŒè¶…æ—¶**Â çš„è¡¥å……ï¼š
>**ä¸ºä»€ä¹ˆéœ€è¦ `tryLock(timeout)` è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿ**
`tryLock(timeout)` æ–¹æ³•å°è¯•åœ¨æŒ‡å®šçš„è¶…æ—¶æ—¶é—´å†…è·å–é”ã€‚å¦‚æœæˆåŠŸè·å–é”ï¼Œåˆ™è¿”å› `true`ï¼›å¦‚æœåœ¨é”å¯ç”¨ä¹‹å‰è¶…æ—¶ï¼Œåˆ™è¿”å› `false`ã€‚æ­¤åŠŸèƒ½åœ¨ä»¥ä¸‹å‡ ç§åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ï¼š
- **é˜²æ­¢æ­»é”ï¼š** åœ¨å¤æ‚çš„é”åœºæ™¯ä¸­ï¼Œ`tryLock(timeout)` å¯ä»¥é€šè¿‡å…è®¸çº¿ç¨‹åœ¨åˆç†çš„æ—¶é—´å†…æ”¾å¼ƒå¹¶é‡è¯•æ¥å¸®åŠ©é˜²æ­¢æ­»é”ã€‚
- **æé«˜å“åº”é€Ÿåº¦ï¼š** é˜²æ­¢çº¿ç¨‹æ— é™æœŸé˜»å¡ã€‚
- **å¤„ç†æ—¶é—´æ•æ„Ÿçš„æ“ä½œï¼š** å¯¹äºå…·æœ‰ä¸¥æ ¼æ—¶é—´é™åˆ¶çš„æ“ä½œï¼Œ`tryLock(timeout)` å…è®¸çº¿ç¨‹åœ¨æ— æ³•åŠæ—¶è·å–é”æ—¶ç»§ç»­æ‰§è¡Œæ›¿ä»£æ“ä½œã€‚

#### å¯ä¸­æ–­é”å’Œä¸å¯ä¸­æ–­é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

- **å¯ä¸­æ–­é”**ï¼šè·å–é”çš„è¿‡ç¨‹ä¸­å¯ä»¥è¢«ä¸­æ–­ï¼Œä¸éœ€è¦ä¸€ç›´ç­‰åˆ°è·å–é”ä¹‹å æ‰èƒ½è¿›è¡Œå…¶ä»–é€»è¾‘å¤„ç†ã€‚`ReentrantLock` å°±å±äºæ˜¯å¯ä¸­æ–­é”ã€‚
- **ä¸å¯ä¸­æ–­é”**ï¼šä¸€æ—¦çº¿ç¨‹ç”³è¯·äº†é”ï¼Œå°±åªèƒ½ç­‰åˆ°æ‹¿åˆ°é”ä»¥åæ‰èƒ½è¿›è¡Œå…¶ä»–çš„é€»è¾‘å¤„ç†ã€‚ `synchronized` å°±å±äºæ˜¯ä¸å¯ä¸­æ–­é”ã€‚